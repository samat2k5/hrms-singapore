# Walkthrough - Foreigner Pass Capture

I have implemented the ability to capture and track Work Pass details for Foreigner employees.

## Changes Made

### Database & Backend
- **Database Schema**: Added `work_pass_type` and `work_pass_expiry` columns to the `employees` table in [init.js](file:///c:/Users/mathi/Desktop/AntiGravity%20Demos/HRMS%20Singapore/server/db/init.js).
- **API Routes**: Updated [employees.js](file:///c:/Users/mathi/Desktop/AntiGravity%20Demos/HRMS%20Singapore/server/routes/employees.js) to process and persist these new fields during employee creation and updates.

### Frontend
- **Employee Form**: Added "Work Pass Type" and "Work Pass Expiry" fields to the [EmployeeForm.jsx](file:///c:/Users/mathi/Desktop/AntiGravity%20Demos/HRMS%20Singapore/client/src/pages/EmployeeForm.jsx).
- **Conditional Visibility**: The new fields only appear when the employee's nationality is set to "Foreigner", keeping the UI clean for Citizens and SPRs.
- **Premium UI**: Integrated the custom [DatePicker](file:///c:/Users/mathi/Desktop/AntiGravity%20Demos/HRMS%20Singapore/client/src/components/DatePicker.jsx#6-42) for the expiry date to match the application's glassmorphism theme.

## Verification Results

### Manual Verification
1.  Navigate to **Employees** > **Add New Employee**.
2.  Select **Foreigner** in the **Nationality** dropdown.
3.  Observe that **Work Pass Type** (Dropdown) and **Work Pass Expiry** (DatePicker) appear below the Nationality field.
4.  Switch nationality to **Singapore Citizen**; verify the fields disappear.
5.  Change back to **Foreigner**, fill in "Employment Pass" and an expiry date.
6.  Save the employee and then re-edit to confirm the data is correctly saved and displayed.

```diff:init.js
const initSQL = require('sql.js');
const path = require('path');
const fs = require('fs');
const bcrypt = require('bcryptjs');

const DB_PATH = path.join(__dirname, 'hrms.sqlite');

let db = null;

async function getDb() {
  if (db) return db;

  const SQL = await initSQL();

  if (fs.existsSync(DB_PATH)) {
    const fileBuffer = fs.readFileSync(DB_PATH);
    db = new SQL.Database(fileBuffer);

    // Entity Migrations
    try {
      const check = db.exec("PRAGMA table_info(entities)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        if (!columns.includes('performance_multiplier')) {
          console.log('[DB] Migrating entities: Adding performance_multiplier...');
          db.run(`ALTER TABLE entities ADD COLUMN performance_multiplier REAL DEFAULT 0`);
        }
        if (!columns.includes('logo_url')) {
          console.log('[DB] Migrating entities: Adding logo_url...');
          db.run(`ALTER TABLE entities ADD COLUMN logo_url TEXT`);
        }
        saveDb();
      }
    } catch (e) { console.error('[DB] Entities migration failed:', e.message); }

    // Employee Table Migrations (Face, Photo, Work Hours)
    try {
      const check = db.exec("PRAGMA table_info(employees)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        const migrations = [
          { name: 'face_descriptor', type: 'TEXT' },
          { name: 'photo_url', type: 'TEXT' },
          { name: 'working_days_per_week', type: 'REAL DEFAULT 5.5' },
          { name: 'rest_day', type: "TEXT DEFAULT 'Sunday'" },
          { name: 'working_hours_per_day', type: 'REAL DEFAULT 8' },
          { name: 'working_hours_per_week', type: 'REAL DEFAULT 44' },
          { name: 'other_deduction', type: 'REAL DEFAULT 0' },
          { name: 'site_id', type: 'INTEGER' },
          { name: 'cessation_date', type: 'DATE' },
          { name: 'pr_status_start_date', type: 'DATE' },
          { name: 'cpf_full_rate_agreed', type: 'BOOLEAN DEFAULT 0' }
        ];

        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            console.log(`[DB] Migrating employees: Adding ${col.name}...`);
            db.run(`ALTER TABLE employees ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }
    } catch (e) { console.error('[DB] Employee table migration failed:', e.message); }

    // MOM Alignment Migrations
    try {
      const check = db.exec("PRAGMA table_info(employee_kets)");
      const columns = check[0].values.map(v => v[1]);
      if (!columns.includes('main_duties')) {
        console.log('[DB] Migrating employee_kets for MOM alignment...');
        const migrations = [
          { name: 'main_duties', type: 'TEXT' },
          { name: 'employment_end_date', type: 'DATE' },
          { name: 'working_hours_details', type: 'TEXT' },
          { name: 'break_hours', type: 'TEXT' },
          { name: 'salary_payment_date', type: 'TEXT' },
          { name: 'overtime_payment_date', type: 'TEXT' },
          { name: 'gross_rate_of_pay', type: 'REAL' },
          { name: 'other_salary_components', type: 'TEXT' },
          { name: 'cpf_payable', type: 'BOOLEAN DEFAULT 1' },
          { name: 'probation_start_date', type: 'DATE' },
          { name: 'probation_end_date', type: 'DATE' }
        ];
        for (const col of migrations) {
          try { if (!columns.includes(col.name)) db.run(`ALTER TABLE employee_kets ADD COLUMN ${col.name} ${col.type}`); } catch (e) { }
        }
        saveDb();
      }
    } catch (e) { console.error('[DB] MOM migration failed:', e.message); }

    // Shift Settings Migrations
    try {
      const check = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='shift_settings'");
      if (check.length > 0) {
        const columnsData = db.exec("PRAGMA table_info(shift_settings)");
        const columns = columnsData[0].values.map(v => v[1]);
        const migrations = [
          { name: 'lunch_break_mins', type: 'INTEGER DEFAULT 60' },
          { name: 'dinner_break_mins', type: 'INTEGER DEFAULT 0' },
          { name: 'midnight_break_mins', type: 'INTEGER DEFAULT 0' }
        ];
        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            db.run(`ALTER TABLE shift_settings ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }
    } catch (e) { }

    // NEW SELF-HEALING: Seed default groups for entities that have none
    try {
      const entities = db.exec("SELECT id FROM entities");
      if (entities.length > 0) {
        const entityIds = entities[0].values.map(v => v[0]);
        let seeded = false;
        for (const eid of entityIds) {
          const groupCount = db.exec("SELECT COUNT(*) FROM employee_groups WHERE entity_id = ?", [eid]);
          if (groupCount[0].values[0][0] === 0) {
            console.log(`[DB] Seeding default groups for entity ${eid}...`);
            db.run(`INSERT INTO employee_groups (entity_id, name, description) VALUES (?, ?, ?)`, [eid, 'General', 'General Group']);
            db.run(`INSERT INTO employee_groups (entity_id, name, description) VALUES (?, ?, ?)`, [eid, 'Executive', 'Executive Group']);
            db.run(`INSERT INTO employee_groups (entity_id, name, description) VALUES (?, ?, ?)`, [eid, 'Operations', 'Operations Group']);
            seeded = true;
          }
        }
        if (seeded) saveDb();
      }
    } catch (e) { console.error('[DB] Group seeding failed:', e.message); }

    // Payroll Runs Migrations
    try {
      const check = db.exec("PRAGMA table_info(payroll_runs)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        if (!columns.includes('is_locked')) {
          console.log('[DB] Migrating payroll_runs: Adding is_locked...');
          db.run(`ALTER TABLE payroll_runs ADD COLUMN is_locked INTEGER DEFAULT 0`);
          saveDb();
        }
      }
    } catch (e) { console.error('[DB] Payroll runs migration failed:', e.message); }

    // Payslips Table Migrations
    try {
      const check = db.exec("PRAGMA table_info(payslips)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        const migrations = [
          { name: 'ns_makeup_pay', type: 'REAL DEFAULT 0' },
          { name: 'ns_days', type: 'REAL DEFAULT 0' }
        ];
        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            console.log(`[DB] Migrating payslips: Adding ${col.name}...`);
            db.run(`ALTER TABLE payslips ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }
    } catch (e) { console.error('[DB] Payslips migration failed:', e.message); }

    // Leave Policies and Balances Migrations
    try {
      const checkPol = db.exec("PRAGMA table_info(leave_policies)");
      if (checkPol.length > 0) {
        const columns = checkPol[0].values.map(v => v[1]);
        const migrations = [
          { name: 'carry_forward_max', type: 'REAL DEFAULT 0' },
          { name: 'carry_forward_expiry_months', type: 'INTEGER DEFAULT 12' },
          { name: 'encashment_allowed', type: 'BOOLEAN DEFAULT 0' }
        ];
        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            db.run(`ALTER TABLE leave_policies ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }

      const checkBal = db.exec("PRAGMA table_info(leave_balances)");
      if (checkBal.length > 0) {
        const columns = checkBal[0].values.map(v => v[1]);
        if (!columns.includes('carried_forward')) {
          db.run(`ALTER TABLE leave_balances ADD COLUMN carried_forward REAL DEFAULT 0`);
          saveDb();
        }
      }
    } catch (e) { console.error('[DB] Leave table migrations failed:', e.message); }

    // Ensure AWOL leave type exists
    try {
      const awolCheck = db.exec("SELECT id FROM leave_types WHERE name = 'AWOL'");
      let awolId = null;
      if (!awolCheck.length || !awolCheck[0].values.length) {
        console.log("[DB] Adding missing AWOL leave type...");
        db.run("INSERT INTO leave_types (name, default_days) VALUES (?, ?)", ['AWOL', 0]);
        awolId = db.exec("SELECT id FROM leave_types WHERE name = 'AWOL'")[0].values[0][0];
        saveDb();
      } else {
        awolId = awolCheck[0].values[0][0];
      }

      // Ensure all employees have an AWOL balance record for existing years
      if (awolId) {
        db.run(`
            INSERT INTO leave_balances (employee_id, leave_type_id, year, entitled, taken, balance, carried_forward)
            SELECT DISTINCT employee_id, ?, year, 0, 0, 0, 0 FROM leave_balances lb1
            WHERE NOT EXISTS (
                SELECT 1 FROM leave_balances lb2 
                WHERE lb2.employee_id = lb1.employee_id 
                AND lb2.year = lb1.year 
                AND lb2.leave_type_id = ?
            )
        `, [awolId, awolId]);
        saveDb();
      }
    } catch (e) { console.error('[DB] AWOL leave type migration failed:', e.message); }

    // IRAS Compliance Tables Migration
    const irasTables = [
      {
        name: 'iras_benefits_in_kind',
        sql: `CREATE TABLE IF NOT EXISTS iras_benefits_in_kind (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          employee_id INTEGER NOT NULL,
          year INTEGER NOT NULL,
          category TEXT NOT NULL,
          description TEXT,
          value REAL DEFAULT 0,
          period_from DATE,
          period_to DATE
        )`
      },
      {
        name: 'iras_share_options',
        sql: `CREATE TABLE IF NOT EXISTS iras_share_options (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          employee_id INTEGER NOT NULL,
          year INTEGER NOT NULL,
          plan_type TEXT,
          grant_date DATE,
          exercise_date DATE,
          exercise_price REAL,
          market_value REAL,
          shares_count INTEGER,
          taxable_profit REAL
        )`
      },
      {
        name: 'iras_submissions',
        sql: `CREATE TABLE IF NOT EXISTS iras_submissions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          entity_id INTEGER NOT NULL,
          submission_id TEXT UNIQUE,
          year INTEGER NOT NULL,
          type TEXT NOT NULL,
          status TEXT NOT NULL,
          payload_json TEXT,
          response_json TEXT,
          timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (entity_id) REFERENCES entities(id)
        )`
      },
      {
        name: 'ns_claims',
        sql: `CREATE TABLE IF NOT EXISTS ns_claims (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          entity_id INTEGER NOT NULL,
          employee_id INTEGER NOT NULL,
          start_date DATE NOT NULL,
          end_date DATE NOT NULL,
          total_days INTEGER NOT NULL,
          claim_amount REAL,
          status TEXT DEFAULT 'Pending',
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (entity_id) REFERENCES entities(id),
          FOREIGN KEY (employee_id) REFERENCES employees(id)
        )`
      }
    ];

    for (const table of irasTables) {
      try {
        db.run(table.sql);
      } catch (e) { console.error(`[DB] Failed to create ${table.name}:`, e.message); }
    }
    saveDb();

  } else {
    db = new SQL.Database();
    createSchema(db);
    seedData(db);
    seedConfigData(db);
    saveDb();
  }

  // Ensure default roles exist
  try {
    const rolesCheck = db.exec("SELECT COUNT(*) FROM user_roles");
    if (rolesCheck[0].values[0][0] === 0) {
      db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Admin', 'Full system access', JSON.stringify(['attendance:import:cross-entity'])]);
      db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['HR', 'Human resources and payroll management', JSON.stringify(['attendance:import:cross-entity'])]);
      db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Operations Admin', 'Admin access to operations only. Restricted from Entity, Users, Roles masters.', JSON.stringify(['attendance:import:cross-entity'])]);
      saveDb();
    } else {
      // Check if Operations Admin exists, if not add it
      const opsAdminCheck = db.exec("SELECT id FROM user_roles WHERE name = 'Operations Admin'");
      if (!opsAdminCheck.length || !opsAdminCheck[0].values.length) {
        console.log('[DB] Adding missing Operations Admin role...');
        db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Operations Admin', 'Admin access to operations only. Restricted from Entity, Users, Roles masters.', JSON.stringify(['attendance:import:cross-entity'])]);
        saveDb();
      }
    }
  } catch (e) { console.error('[DB] User roles check/seed failed:', e.message); }

  return db;
}

function saveDb() {
  if (!db) return;
  try {
    const data = db.export();
    const buffer = Buffer.from(data);
    fs.writeFileSync(DB_PATH, buffer);
    console.log(`[DB] Saved to ${DB_PATH} (${buffer.length} bytes)`);
  } catch (err) {
    console.error(`[DB] Failed to save to ${DB_PATH}:`, err.message);
  }
}

function reloadDb() {
  db = null;
  console.log('[DB] Database variable cleared for reload');
}

function createSchema(database) {
  database.run(`
    CREATE TABLE IF NOT EXISTS entities (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      uen TEXT UNIQUE,
      name TEXT NOT NULL,
      address TEXT,
      contact_number TEXT,
      website TEXT,
      email_domains TEXT,
      logo_url TEXT,
      performance_multiplier REAL DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS user_entity_roles (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      entity_id INTEGER NOT NULL,
      role TEXT DEFAULT 'HR',
      managed_groups TEXT DEFAULT '[]',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES users(id),
      FOREIGN KEY (entity_id) REFERENCES entities(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS departments (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_groups (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_grades (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS email_domains (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      domain TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, domain)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS holidays (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      date DATE NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name, date)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE NOT NULL,
      password_hash TEXT NOT NULL,
      full_name TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employees (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id TEXT NOT NULL,
      full_name TEXT NOT NULL,
      date_of_birth DATE,
      national_id TEXT,
      nationality TEXT DEFAULT 'Singapore Citizen',
      tax_residency TEXT DEFAULT 'Resident',
      race TEXT,
      designation TEXT,
      department TEXT,
      employee_group TEXT,
      employee_grade TEXT DEFAULT '',
      gender TEXT,
      language TEXT,
      mobile_number TEXT,
      whatsapp_number TEXT,
      email TEXT,
      highest_education TEXT,
      date_joined DATE,
      cessation_date DATE,
      basic_salary REAL,
      transport_allowance REAL,
      meal_allowance REAL,
      other_allowance REAL,
      other_deduction REAL DEFAULT 0,
      custom_allowances TEXT DEFAULT '{}',
      custom_deductions TEXT DEFAULT '{}',
      payment_mode TEXT DEFAULT 'Bank Transfer',
      bank_name TEXT,
      bank_account TEXT,
      cpf_applicable BOOLEAN DEFAULT 1,
      pr_status_start_date DATE,
      cpf_full_rate_agreed BOOLEAN DEFAULT 0,
      working_days_per_week REAL DEFAULT 5.5,
      rest_day TEXT DEFAULT 'Sunday',
      working_hours_per_day REAL DEFAULT 8,
      working_hours_per_week REAL DEFAULT 44,
      site_id INTEGER,
      photo_url TEXT,
      status TEXT DEFAULT 'Active',
      face_descriptor TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, employee_id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_documents (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      document_type TEXT NOT NULL,
      document_number TEXT NOT NULL,
      issue_date DATE,
      expiry_date DATE,
      file_path TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_kets (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      job_title TEXT,
      employment_start_date DATE,
      employment_type TEXT DEFAULT 'Permanent',
      contract_duration TEXT,
      working_hours_per_day REAL DEFAULT 8,
      working_days_per_week INTEGER DEFAULT 5,
      rest_day TEXT DEFAULT 'Sunday',
      salary_period TEXT DEFAULT 'Monthly',
      basic_salary REAL DEFAULT 0,
      fixed_allowances TEXT DEFAULT '{}',
      fixed_deductions TEXT DEFAULT '{}',
      custom_allowances TEXT DEFAULT '{}',
      custom_deductions TEXT DEFAULT '{}',
      employee_grade TEXT DEFAULT '',
      overtime_rate REAL DEFAULT 0,
      overtime_payment_period TEXT,
      bonus_structure TEXT,
      annual_leave_days INTEGER DEFAULT 7,
      sick_leave_days INTEGER DEFAULT 14,
      hospitalization_days INTEGER DEFAULT 60,
      maternity_weeks INTEGER DEFAULT 16,
      paternity_weeks INTEGER DEFAULT 2,
      childcare_days INTEGER DEFAULT 6,
      medical_benefits TEXT,
      probation_months INTEGER DEFAULT 3,
      notice_period TEXT DEFAULT '1 month',
      place_of_work TEXT,
      main_duties TEXT,
      employment_end_date DATE,
      working_hours_details TEXT,
      break_hours TEXT,
      salary_payment_date TEXT,
      overtime_payment_date TEXT,
      gross_rate_of_pay REAL,
      other_salary_components TEXT,
      cpf_payable BOOLEAN DEFAULT 1,
      probation_start_date DATE,
      probation_end_date DATE,
      issued_date DATE,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_types (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      default_days REAL NOT NULL
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_policies (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_grade TEXT NOT NULL,
      leave_type_id INTEGER NOT NULL,
      base_days REAL DEFAULT 0,
      increment_per_year REAL DEFAULT 0,
      max_days REAL DEFAULT 0,
      carry_forward_max REAL DEFAULT 0,
      carry_forward_expiry_months INTEGER DEFAULT 12,
      encashment_allowed BOOLEAN DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (leave_type_id) REFERENCES leave_types(id),
      UNIQUE(entity_id, employee_grade, leave_type_id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_balances (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      leave_type_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      entitled REAL DEFAULT 0,
      carried_forward REAL DEFAULT 0,
      taken REAL DEFAULT 0,
      balance REAL DEFAULT 0,
      FOREIGN KEY (employee_id) REFERENCES employees(id),
      FOREIGN KEY (leave_type_id) REFERENCES leave_types(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_requests (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      leave_type_id INTEGER NOT NULL,
      start_date DATE NOT NULL,
      end_date DATE NOT NULL,
      days REAL NOT NULL,
      reason TEXT,
      status TEXT DEFAULT 'Pending',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (employee_id) REFERENCES employees(id),
      FOREIGN KEY (leave_type_id) REFERENCES leave_types(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS payroll_runs (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_group TEXT NOT NULL,
      period_year INTEGER NOT NULL,
      period_month INTEGER NOT NULL,
      run_date DATE NOT NULL,
      payment_date DATE,
      total_gross REAL DEFAULT 0,
      total_cpf_employee REAL DEFAULT 0,
      total_cpf_employer REAL DEFAULT 0,
      total_sdl REAL DEFAULT 0,
      total_shg REAL DEFAULT 0,
      total_net REAL DEFAULT 0,
      status TEXT DEFAULT 'Draft',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS payslips (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      payroll_run_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      employee_name TEXT,
      employee_code TEXT,
      basic_salary REAL DEFAULT 0,
      transport_allowance REAL DEFAULT 0,
      meal_allowance REAL DEFAULT 0,
      other_allowance REAL DEFAULT 0,
      total_allowances REAL DEFAULT 0,
      overtime_hours REAL DEFAULT 0,
      overtime_pay REAL DEFAULT 0,
      ot_1_5_hours REAL DEFAULT 0,
      ot_2_0_hours REAL DEFAULT 0,
      ot_1_5_pay REAL DEFAULT 0,
      ot_2_0_pay REAL DEFAULT 0,
      ph_worked_pay REAL DEFAULT 0,
      ph_off_day_pay REAL DEFAULT 0,
      bonus REAL DEFAULT 0,
      custom_allowances TEXT DEFAULT '{}',
      custom_deductions TEXT DEFAULT '{}',
      payment_mode TEXT DEFAULT 'Bank Transfer',
      gross_pay REAL DEFAULT 0,
      cpf_employee REAL DEFAULT 0,
      cpf_employer REAL DEFAULT 0,
      cpf_oa REAL DEFAULT 0,
      cpf_sa REAL DEFAULT 0,
      cpf_ma REAL DEFAULT 0,
      sdl REAL DEFAULT 0,
      shg_deduction REAL DEFAULT 0,
      shg_fund TEXT,
      other_deductions REAL DEFAULT 0,
      unpaid_leave_days REAL DEFAULT 0,
      unpaid_leave_deduction REAL DEFAULT 0,
      late_mins INTEGER DEFAULT 0,
      early_out_mins INTEGER DEFAULT 0,
      attendance_deduction REAL DEFAULT 0,
      performance_allowance REAL DEFAULT 0,
      ns_makeup_pay REAL DEFAULT 0,
      ns_days REAL DEFAULT 0,
      net_pay REAL DEFAULT 0,
      compliance_notes TEXT DEFAULT '',
      FOREIGN KEY (payroll_run_id) REFERENCES payroll_runs(id),
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS user_roles (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT UNIQUE NOT NULL,
      description TEXT,
      permissions TEXT DEFAULT '[]',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS timesheets (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      date DATE NOT NULL,
      in_time TEXT,
      out_time TEXT,
      shift TEXT,
      ot_hours REAL DEFAULT 0,
      ot_1_5_hours REAL DEFAULT 0,
      ot_2_0_hours REAL DEFAULT 0,
      remarks TEXT,
      source_file TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(entity_id) REFERENCES entities(id),
      FOREIGN KEY(employee_id) REFERENCES employees(id),
      UNIQUE(entity_id, employee_id, date)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS attendance_remarks (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      date DATE NOT NULL,
      remark_type TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(entity_id) REFERENCES entities(id),
      FOREIGN KEY(employee_id) REFERENCES employees(id),
      UNIQUE(entity_id, employee_id, date)
    )
  `);

  // IRAS Compliance Tables
  database.run(`
    CREATE TABLE IF NOT EXISTS submission_logs (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      user_id INTEGER NOT NULL,
      username TEXT,
      submission_type TEXT NOT NULL,
      file_type TEXT,
      acknowledgment_no TEXT,
      records_count INTEGER DEFAULT 0,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (user_id) REFERENCES users(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_forms (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      form_type TEXT NOT NULL,
      data_json TEXT NOT NULL,
      status TEXT DEFAULT 'Generated',
      version INTEGER DEFAULT 1,
      generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      is_locked BOOLEAN DEFAULT 1,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_benefits_in_kind (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      category TEXT NOT NULL,
      description TEXT,
      value REAL DEFAULT 0,
      period_from DATE,
      period_to DATE
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_submissions (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      submission_id TEXT UNIQUE,
      year INTEGER NOT NULL,
      type TEXT NOT NULL,
      status TEXT NOT NULL,
      payload_json TEXT,
      response_json TEXT,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS ns_claims (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      start_date DATE NOT NULL,
      end_date DATE NOT NULL,
      total_days INTEGER NOT NULL,
      claim_amount REAL,
      status TEXT DEFAULT 'Pending',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_share_options (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      plan_type TEXT,
      grant_date DATE,
      exercise_date DATE,
      exercise_price REAL,
      market_value REAL,
      shares_count INTEGER,
      taxable_profit REAL
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS shift_settings_v2 (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      shift_name TEXT NOT NULL,
      start_time TEXT DEFAULT '08:00',
      end_time TEXT DEFAULT '17:00',
      ot_start_time TEXT DEFAULT '17:30',
      late_arrival_threshold_mins INTEGER DEFAULT 15,
      early_departure_threshold_mins INTEGER DEFAULT 15,
      late_arrival_penalty_block_mins INTEGER DEFAULT 0,
      early_departure_penalty_block_mins INTEGER DEFAULT 0,
      compulsory_ot_hours REAL DEFAULT 0,
      lunch_break_mins INTEGER DEFAULT 60,
      dinner_break_mins INTEGER DEFAULT 0,
      midnight_break_mins INTEGER DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, shift_name)
    )
  `);
}

function seedData(database) {
  const systemHash = bcrypt.hashSync('manager', 10);
  database.run(`INSERT INTO entities (name, uen, address, contact_number, website, email_domains) VALUES (?, ?, ?, ?, ?, ?)`, ['Hypex Pte Ltd', '202012345A', '123 Tech Lane, Singapore', '65432100', 'https://hypex.sg', 'hypex.com.sg, gmail.com, yahoo.com']);
  database.run(`INSERT INTO entities (name, uen, address, contact_number, website, email_domains) VALUES (?, ?, ?, ?, ?, ?)`, ['Samat Global', '202167890B', '456 Global Way, Singapore', '67890011', 'https://samat.com', 'samat.com, gmail.com']);

  database.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Admin', 'Full system access', JSON.stringify(['attendance:import:cross-entity'])]);
  database.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['HR', 'Human resources and payroll management', JSON.stringify(['attendance:import:cross-entity'])]);
  database.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Operations Admin', 'Admin access to operations only. Restricted from Entity, Users, Roles masters.', JSON.stringify(['attendance:import:cross-entity'])]);

  database.run(`INSERT INTO users (username, password_hash, full_name) VALUES (?, ?, ?)`, ['system', systemHash, 'System Administrator']);
  database.run(`INSERT INTO user_entity_roles (user_id, entity_id, role, managed_groups) VALUES (?, ?, ?, ?)`, [1, 1, 'Admin', '[]']);
  database.run(`INSERT INTO user_entity_roles (user_id, entity_id, role, managed_groups) VALUES (?, ?, ?, ?)`, [1, 2, 'Admin', '[]']);
}

function seedConfigData(database) {
  // MOM-compliant leave types
  const leaveTypes = [
    ['Annual Leave', 7],
    ['Medical Leave', 14],
    ['Hospitalization Leave', 60],
    ['Childcare Leave', 6],
    ['Maternity Leave', 112],
    ['Paternity Leave', 24],
    ['Shared Parental Leave', 60],
    ['Compassionate Leave', 3],
    ['Unpaid Leave', 0],
    ['AWOL', 0]
  ];
  leaveTypes.forEach(([name, days]) => {
    database.run(`INSERT INTO leave_types (name, default_days) VALUES (?, ?)`, [name, days]);
  });
}

module.exports = { getDb, saveDb, reloadDb };
===
const initSQL = require('sql.js');
const path = require('path');
const fs = require('fs');
const bcrypt = require('bcryptjs');

const DB_PATH = path.join(__dirname, 'hrms.sqlite');

let db = null;

async function getDb() {
  if (db) return db;

  const SQL = await initSQL();

  if (fs.existsSync(DB_PATH)) {
    const fileBuffer = fs.readFileSync(DB_PATH);
    db = new SQL.Database(fileBuffer);

    // Entity Migrations
    try {
      const check = db.exec("PRAGMA table_info(entities)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        if (!columns.includes('performance_multiplier')) {
          console.log('[DB] Migrating entities: Adding performance_multiplier...');
          db.run(`ALTER TABLE entities ADD COLUMN performance_multiplier REAL DEFAULT 0`);
        }
        if (!columns.includes('logo_url')) {
          console.log('[DB] Migrating entities: Adding logo_url...');
          db.run(`ALTER TABLE entities ADD COLUMN logo_url TEXT`);
        }
        saveDb();
      }
    } catch (e) { console.error('[DB] Entities migration failed:', e.message); }

    // Employee Table Migrations (Face, Photo, Work Hours)
    try {
      const check = db.exec("PRAGMA table_info(employees)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        const migrations = [
          { name: 'face_descriptor', type: 'TEXT' },
          { name: 'photo_url', type: 'TEXT' },
          { name: 'working_days_per_week', type: 'REAL DEFAULT 5.5' },
          { name: 'rest_day', type: "TEXT DEFAULT 'Sunday'" },
          { name: 'working_hours_per_day', type: 'REAL DEFAULT 8' },
          { name: 'working_hours_per_week', type: 'REAL DEFAULT 44' },
          { name: 'other_deduction', type: 'REAL DEFAULT 0' },
          { name: 'site_id', type: 'INTEGER' },
          { name: 'cessation_date', type: 'DATE' },
          { name: 'pr_status_start_date', type: 'DATE' },
          { name: 'cpf_full_rate_agreed', type: 'BOOLEAN DEFAULT 0' },
          { name: 'work_pass_type', type: 'TEXT' },
          { name: 'work_pass_expiry', type: 'DATE' }
        ];

        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            console.log(`[DB] Migrating employees: Adding ${col.name}...`);
            db.run(`ALTER TABLE employees ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }
    } catch (e) { console.error('[DB] Employee table migration failed:', e.message); }

    // MOM Alignment Migrations
    try {
      const check = db.exec("PRAGMA table_info(employee_kets)");
      const columns = check[0].values.map(v => v[1]);
      if (!columns.includes('main_duties')) {
        console.log('[DB] Migrating employee_kets for MOM alignment...');
        const migrations = [
          { name: 'main_duties', type: 'TEXT' },
          { name: 'employment_end_date', type: 'DATE' },
          { name: 'working_hours_details', type: 'TEXT' },
          { name: 'break_hours', type: 'TEXT' },
          { name: 'salary_payment_date', type: 'TEXT' },
          { name: 'overtime_payment_date', type: 'TEXT' },
          { name: 'gross_rate_of_pay', type: 'REAL' },
          { name: 'other_salary_components', type: 'TEXT' },
          { name: 'cpf_payable', type: 'BOOLEAN DEFAULT 1' },
          { name: 'probation_start_date', type: 'DATE' },
          { name: 'probation_end_date', type: 'DATE' }
        ];
        for (const col of migrations) {
          try { if (!columns.includes(col.name)) db.run(`ALTER TABLE employee_kets ADD COLUMN ${col.name} ${col.type}`); } catch (e) { }
        }
        saveDb();
      }
    } catch (e) { console.error('[DB] MOM migration failed:', e.message); }

    // Shift Settings Migrations
    try {
      const check = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='shift_settings'");
      if (check.length > 0) {
        const columnsData = db.exec("PRAGMA table_info(shift_settings)");
        const columns = columnsData[0].values.map(v => v[1]);
        const migrations = [
          { name: 'lunch_break_mins', type: 'INTEGER DEFAULT 60' },
          { name: 'dinner_break_mins', type: 'INTEGER DEFAULT 0' },
          { name: 'midnight_break_mins', type: 'INTEGER DEFAULT 0' }
        ];
        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            db.run(`ALTER TABLE shift_settings ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }
    } catch (e) { }

    // NEW SELF-HEALING: Seed default groups for entities that have none
    try {
      const entities = db.exec("SELECT id FROM entities");
      if (entities.length > 0) {
        const entityIds = entities[0].values.map(v => v[0]);
        let seeded = false;
        for (const eid of entityIds) {
          const groupCount = db.exec("SELECT COUNT(*) FROM employee_groups WHERE entity_id = ?", [eid]);
          if (groupCount[0].values[0][0] === 0) {
            console.log(`[DB] Seeding default groups for entity ${eid}...`);
            db.run(`INSERT INTO employee_groups (entity_id, name, description) VALUES (?, ?, ?)`, [eid, 'General', 'General Group']);
            db.run(`INSERT INTO employee_groups (entity_id, name, description) VALUES (?, ?, ?)`, [eid, 'Executive', 'Executive Group']);
            db.run(`INSERT INTO employee_groups (entity_id, name, description) VALUES (?, ?, ?)`, [eid, 'Operations', 'Operations Group']);
            seeded = true;
          }
        }
        if (seeded) saveDb();
      }
    } catch (e) { console.error('[DB] Group seeding failed:', e.message); }

    // Payroll Runs Migrations
    try {
      const check = db.exec("PRAGMA table_info(payroll_runs)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        if (!columns.includes('is_locked')) {
          console.log('[DB] Migrating payroll_runs: Adding is_locked...');
          db.run(`ALTER TABLE payroll_runs ADD COLUMN is_locked INTEGER DEFAULT 0`);
          saveDb();
        }
      }
    } catch (e) { console.error('[DB] Payroll runs migration failed:', e.message); }

    // Payslips Table Migrations
    try {
      const check = db.exec("PRAGMA table_info(payslips)");
      if (check.length > 0) {
        const columns = check[0].values.map(v => v[1]);
        const migrations = [
          { name: 'ns_makeup_pay', type: 'REAL DEFAULT 0' },
          { name: 'ns_days', type: 'REAL DEFAULT 0' }
        ];
        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            console.log(`[DB] Migrating payslips: Adding ${col.name}...`);
            db.run(`ALTER TABLE payslips ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }
    } catch (e) { console.error('[DB] Payslips migration failed:', e.message); }

    // Leave Policies and Balances Migrations
    try {
      const checkPol = db.exec("PRAGMA table_info(leave_policies)");
      if (checkPol.length > 0) {
        const columns = checkPol[0].values.map(v => v[1]);
        const migrations = [
          { name: 'carry_forward_max', type: 'REAL DEFAULT 0' },
          { name: 'carry_forward_expiry_months', type: 'INTEGER DEFAULT 12' },
          { name: 'encashment_allowed', type: 'BOOLEAN DEFAULT 0' }
        ];
        let migrated = false;
        for (const col of migrations) {
          if (!columns.includes(col.name)) {
            db.run(`ALTER TABLE leave_policies ADD COLUMN ${col.name} ${col.type}`);
            migrated = true;
          }
        }
        if (migrated) saveDb();
      }

      const checkBal = db.exec("PRAGMA table_info(leave_balances)");
      if (checkBal.length > 0) {
        const columns = checkBal[0].values.map(v => v[1]);
        if (!columns.includes('carried_forward')) {
          db.run(`ALTER TABLE leave_balances ADD COLUMN carried_forward REAL DEFAULT 0`);
          saveDb();
        }
      }
    } catch (e) { console.error('[DB] Leave table migrations failed:', e.message); }

    // Ensure AWOL leave type exists
    try {
      const awolCheck = db.exec("SELECT id FROM leave_types WHERE name = 'AWOL'");
      let awolId = null;
      if (!awolCheck.length || !awolCheck[0].values.length) {
        console.log("[DB] Adding missing AWOL leave type...");
        db.run("INSERT INTO leave_types (name, default_days) VALUES (?, ?)", ['AWOL', 0]);
        awolId = db.exec("SELECT id FROM leave_types WHERE name = 'AWOL'")[0].values[0][0];
        saveDb();
      } else {
        awolId = awolCheck[0].values[0][0];
      }

      // Ensure all employees have an AWOL balance record for existing years
      if (awolId) {
        db.run(`
            INSERT INTO leave_balances (employee_id, leave_type_id, year, entitled, taken, balance, carried_forward)
            SELECT DISTINCT employee_id, ?, year, 0, 0, 0, 0 FROM leave_balances lb1
            WHERE NOT EXISTS (
                SELECT 1 FROM leave_balances lb2 
                WHERE lb2.employee_id = lb1.employee_id 
                AND lb2.year = lb1.year 
                AND lb2.leave_type_id = ?
            )
        `, [awolId, awolId]);
        saveDb();
      }
    } catch (e) { console.error('[DB] AWOL leave type migration failed:', e.message); }

    // IRAS Compliance Tables Migration
    const irasTables = [
      {
        name: 'iras_benefits_in_kind',
        sql: `CREATE TABLE IF NOT EXISTS iras_benefits_in_kind (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          employee_id INTEGER NOT NULL,
          year INTEGER NOT NULL,
          category TEXT NOT NULL,
          description TEXT,
          value REAL DEFAULT 0,
          period_from DATE,
          period_to DATE
        )`
      },
      {
        name: 'iras_share_options',
        sql: `CREATE TABLE IF NOT EXISTS iras_share_options (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          employee_id INTEGER NOT NULL,
          year INTEGER NOT NULL,
          plan_type TEXT,
          grant_date DATE,
          exercise_date DATE,
          exercise_price REAL,
          market_value REAL,
          shares_count INTEGER,
          taxable_profit REAL
        )`
      },
      {
        name: 'iras_submissions',
        sql: `CREATE TABLE IF NOT EXISTS iras_submissions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          entity_id INTEGER NOT NULL,
          submission_id TEXT UNIQUE,
          year INTEGER NOT NULL,
          type TEXT NOT NULL,
          status TEXT NOT NULL,
          payload_json TEXT,
          response_json TEXT,
          timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (entity_id) REFERENCES entities(id)
        )`
      },
      {
        name: 'ns_claims',
        sql: `CREATE TABLE IF NOT EXISTS ns_claims (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          entity_id INTEGER NOT NULL,
          employee_id INTEGER NOT NULL,
          start_date DATE NOT NULL,
          end_date DATE NOT NULL,
          total_days INTEGER NOT NULL,
          claim_amount REAL,
          status TEXT DEFAULT 'Pending',
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (entity_id) REFERENCES entities(id),
          FOREIGN KEY (employee_id) REFERENCES employees(id)
        )`
      }
    ];

    for (const table of irasTables) {
      try {
        db.run(table.sql);
      } catch (e) { console.error(`[DB] Failed to create ${table.name}:`, e.message); }
    }
    saveDb();

  } else {
    db = new SQL.Database();
    createSchema(db);
    seedData(db);
    seedConfigData(db);
    saveDb();
  }

  // Ensure default roles exist
  try {
    const rolesCheck = db.exec("SELECT COUNT(*) FROM user_roles");
    if (rolesCheck[0].values[0][0] === 0) {
      db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Admin', 'Full system access', JSON.stringify(['attendance:import:cross-entity'])]);
      db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['HR', 'Human resources and payroll management', JSON.stringify(['attendance:import:cross-entity'])]);
      db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Operations Admin', 'Admin access to operations only. Restricted from Entity, Users, Roles masters.', JSON.stringify(['attendance:import:cross-entity'])]);
      saveDb();
    } else {
      // Check if Operations Admin exists, if not add it
      const opsAdminCheck = db.exec("SELECT id FROM user_roles WHERE name = 'Operations Admin'");
      if (!opsAdminCheck.length || !opsAdminCheck[0].values.length) {
        console.log('[DB] Adding missing Operations Admin role...');
        db.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Operations Admin', 'Admin access to operations only. Restricted from Entity, Users, Roles masters.', JSON.stringify(['attendance:import:cross-entity'])]);
        saveDb();
      }
    }
  } catch (e) { console.error('[DB] User roles check/seed failed:', e.message); }

  return db;
}

function saveDb() {
  if (!db) return;
  try {
    const data = db.export();
    const buffer = Buffer.from(data);
    fs.writeFileSync(DB_PATH, buffer);
    console.log(`[DB] Saved to ${DB_PATH} (${buffer.length} bytes)`);
  } catch (err) {
    console.error(`[DB] Failed to save to ${DB_PATH}:`, err.message);
  }
}

function reloadDb() {
  db = null;
  console.log('[DB] Database variable cleared for reload');
}

function createSchema(database) {
  database.run(`
    CREATE TABLE IF NOT EXISTS entities (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      uen TEXT UNIQUE,
      name TEXT NOT NULL,
      address TEXT,
      contact_number TEXT,
      website TEXT,
      email_domains TEXT,
      logo_url TEXT,
      performance_multiplier REAL DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS user_entity_roles (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      entity_id INTEGER NOT NULL,
      role TEXT DEFAULT 'HR',
      managed_groups TEXT DEFAULT '[]',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES users(id),
      FOREIGN KEY (entity_id) REFERENCES entities(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS departments (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_groups (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_grades (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS email_domains (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      domain TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, domain)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS holidays (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      name TEXT NOT NULL,
      date DATE NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, name, date)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      username TEXT UNIQUE NOT NULL,
      password_hash TEXT NOT NULL,
      full_name TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employees (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id TEXT NOT NULL,
      full_name TEXT NOT NULL,
      date_of_birth DATE,
      national_id TEXT,
      nationality TEXT DEFAULT 'Singapore Citizen',
      tax_residency TEXT DEFAULT 'Resident',
      race TEXT,
      designation TEXT,
      department TEXT,
      employee_group TEXT,
      employee_grade TEXT DEFAULT '',
      gender TEXT,
      language TEXT,
      mobile_number TEXT,
      whatsapp_number TEXT,
      email TEXT,
      highest_education TEXT,
      date_joined DATE,
      cessation_date DATE,
      basic_salary REAL,
      transport_allowance REAL,
      meal_allowance REAL,
      other_allowance REAL,
      other_deduction REAL DEFAULT 0,
      custom_allowances TEXT DEFAULT '{}',
      custom_deductions TEXT DEFAULT '{}',
      payment_mode TEXT DEFAULT 'Bank Transfer',
      bank_name TEXT,
      bank_account TEXT,
      cpf_applicable BOOLEAN DEFAULT 1,
      pr_status_start_date DATE,
      cpf_full_rate_agreed BOOLEAN DEFAULT 0,
      working_days_per_week REAL DEFAULT 5.5,
      rest_day TEXT DEFAULT 'Sunday',
      working_hours_per_day REAL DEFAULT 8,
      working_hours_per_week REAL DEFAULT 44,
      site_id INTEGER,
      photo_url TEXT,
      status TEXT DEFAULT 'Active',
      face_descriptor TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, employee_id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_documents (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      document_type TEXT NOT NULL,
      document_number TEXT NOT NULL,
      issue_date DATE,
      expiry_date DATE,
      file_path TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS employee_kets (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      job_title TEXT,
      employment_start_date DATE,
      employment_type TEXT DEFAULT 'Permanent',
      contract_duration TEXT,
      working_hours_per_day REAL DEFAULT 8,
      working_days_per_week INTEGER DEFAULT 5,
      rest_day TEXT DEFAULT 'Sunday',
      salary_period TEXT DEFAULT 'Monthly',
      basic_salary REAL DEFAULT 0,
      fixed_allowances TEXT DEFAULT '{}',
      fixed_deductions TEXT DEFAULT '{}',
      custom_allowances TEXT DEFAULT '{}',
      custom_deductions TEXT DEFAULT '{}',
      employee_grade TEXT DEFAULT '',
      overtime_rate REAL DEFAULT 0,
      overtime_payment_period TEXT,
      bonus_structure TEXT,
      annual_leave_days INTEGER DEFAULT 7,
      sick_leave_days INTEGER DEFAULT 14,
      hospitalization_days INTEGER DEFAULT 60,
      maternity_weeks INTEGER DEFAULT 16,
      paternity_weeks INTEGER DEFAULT 2,
      childcare_days INTEGER DEFAULT 6,
      medical_benefits TEXT,
      probation_months INTEGER DEFAULT 3,
      notice_period TEXT DEFAULT '1 month',
      place_of_work TEXT,
      main_duties TEXT,
      employment_end_date DATE,
      working_hours_details TEXT,
      break_hours TEXT,
      salary_payment_date TEXT,
      overtime_payment_date TEXT,
      gross_rate_of_pay REAL,
      other_salary_components TEXT,
      cpf_payable BOOLEAN DEFAULT 1,
      probation_start_date DATE,
      probation_end_date DATE,
      issued_date DATE,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_types (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      default_days REAL NOT NULL
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_policies (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_grade TEXT NOT NULL,
      leave_type_id INTEGER NOT NULL,
      base_days REAL DEFAULT 0,
      increment_per_year REAL DEFAULT 0,
      max_days REAL DEFAULT 0,
      carry_forward_max REAL DEFAULT 0,
      carry_forward_expiry_months INTEGER DEFAULT 12,
      encashment_allowed BOOLEAN DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (leave_type_id) REFERENCES leave_types(id),
      UNIQUE(entity_id, employee_grade, leave_type_id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_balances (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      leave_type_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      entitled REAL DEFAULT 0,
      carried_forward REAL DEFAULT 0,
      taken REAL DEFAULT 0,
      balance REAL DEFAULT 0,
      FOREIGN KEY (employee_id) REFERENCES employees(id),
      FOREIGN KEY (leave_type_id) REFERENCES leave_types(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS leave_requests (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      leave_type_id INTEGER NOT NULL,
      start_date DATE NOT NULL,
      end_date DATE NOT NULL,
      days REAL NOT NULL,
      reason TEXT,
      status TEXT DEFAULT 'Pending',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (employee_id) REFERENCES employees(id),
      FOREIGN KEY (leave_type_id) REFERENCES leave_types(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS payroll_runs (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_group TEXT NOT NULL,
      period_year INTEGER NOT NULL,
      period_month INTEGER NOT NULL,
      run_date DATE NOT NULL,
      payment_date DATE,
      total_gross REAL DEFAULT 0,
      total_cpf_employee REAL DEFAULT 0,
      total_cpf_employer REAL DEFAULT 0,
      total_sdl REAL DEFAULT 0,
      total_shg REAL DEFAULT 0,
      total_net REAL DEFAULT 0,
      status TEXT DEFAULT 'Draft',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS payslips (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      payroll_run_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      employee_name TEXT,
      employee_code TEXT,
      basic_salary REAL DEFAULT 0,
      transport_allowance REAL DEFAULT 0,
      meal_allowance REAL DEFAULT 0,
      other_allowance REAL DEFAULT 0,
      total_allowances REAL DEFAULT 0,
      overtime_hours REAL DEFAULT 0,
      overtime_pay REAL DEFAULT 0,
      ot_1_5_hours REAL DEFAULT 0,
      ot_2_0_hours REAL DEFAULT 0,
      ot_1_5_pay REAL DEFAULT 0,
      ot_2_0_pay REAL DEFAULT 0,
      ph_worked_pay REAL DEFAULT 0,
      ph_off_day_pay REAL DEFAULT 0,
      bonus REAL DEFAULT 0,
      custom_allowances TEXT DEFAULT '{}',
      custom_deductions TEXT DEFAULT '{}',
      payment_mode TEXT DEFAULT 'Bank Transfer',
      gross_pay REAL DEFAULT 0,
      cpf_employee REAL DEFAULT 0,
      cpf_employer REAL DEFAULT 0,
      cpf_oa REAL DEFAULT 0,
      cpf_sa REAL DEFAULT 0,
      cpf_ma REAL DEFAULT 0,
      sdl REAL DEFAULT 0,
      shg_deduction REAL DEFAULT 0,
      shg_fund TEXT,
      other_deductions REAL DEFAULT 0,
      unpaid_leave_days REAL DEFAULT 0,
      unpaid_leave_deduction REAL DEFAULT 0,
      late_mins INTEGER DEFAULT 0,
      early_out_mins INTEGER DEFAULT 0,
      attendance_deduction REAL DEFAULT 0,
      performance_allowance REAL DEFAULT 0,
      ns_makeup_pay REAL DEFAULT 0,
      ns_days REAL DEFAULT 0,
      net_pay REAL DEFAULT 0,
      compliance_notes TEXT DEFAULT '',
      FOREIGN KEY (payroll_run_id) REFERENCES payroll_runs(id),
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS user_roles (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT UNIQUE NOT NULL,
      description TEXT,
      permissions TEXT DEFAULT '[]',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS timesheets (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      date DATE NOT NULL,
      in_time TEXT,
      out_time TEXT,
      shift TEXT,
      ot_hours REAL DEFAULT 0,
      ot_1_5_hours REAL DEFAULT 0,
      ot_2_0_hours REAL DEFAULT 0,
      remarks TEXT,
      source_file TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(entity_id) REFERENCES entities(id),
      FOREIGN KEY(employee_id) REFERENCES employees(id),
      UNIQUE(entity_id, employee_id, date)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS attendance_remarks (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      date DATE NOT NULL,
      remark_type TEXT NOT NULL,
      description TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(entity_id) REFERENCES entities(id),
      FOREIGN KEY(employee_id) REFERENCES employees(id),
      UNIQUE(entity_id, employee_id, date)
    )
  `);

  // IRAS Compliance Tables
  database.run(`
    CREATE TABLE IF NOT EXISTS submission_logs (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      user_id INTEGER NOT NULL,
      username TEXT,
      submission_type TEXT NOT NULL,
      file_type TEXT,
      acknowledgment_no TEXT,
      records_count INTEGER DEFAULT 0,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (user_id) REFERENCES users(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_forms (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      form_type TEXT NOT NULL,
      data_json TEXT NOT NULL,
      status TEXT DEFAULT 'Generated',
      version INTEGER DEFAULT 1,
      generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      is_locked BOOLEAN DEFAULT 1,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_benefits_in_kind (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      category TEXT NOT NULL,
      description TEXT,
      value REAL DEFAULT 0,
      period_from DATE,
      period_to DATE
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_submissions (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      submission_id TEXT UNIQUE,
      year INTEGER NOT NULL,
      type TEXT NOT NULL,
      status TEXT NOT NULL,
      payload_json TEXT,
      response_json TEXT,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS ns_claims (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      employee_id INTEGER NOT NULL,
      start_date DATE NOT NULL,
      end_date DATE NOT NULL,
      total_days INTEGER NOT NULL,
      claim_amount REAL,
      status TEXT DEFAULT 'Pending',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      FOREIGN KEY (employee_id) REFERENCES employees(id)
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS iras_share_options (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      employee_id INTEGER NOT NULL,
      year INTEGER NOT NULL,
      plan_type TEXT,
      grant_date DATE,
      exercise_date DATE,
      exercise_price REAL,
      market_value REAL,
      shares_count INTEGER,
      taxable_profit REAL
    )
  `);

  database.run(`
    CREATE TABLE IF NOT EXISTS shift_settings_v2 (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      entity_id INTEGER NOT NULL,
      shift_name TEXT NOT NULL,
      start_time TEXT DEFAULT '08:00',
      end_time TEXT DEFAULT '17:00',
      ot_start_time TEXT DEFAULT '17:30',
      late_arrival_threshold_mins INTEGER DEFAULT 15,
      early_departure_threshold_mins INTEGER DEFAULT 15,
      late_arrival_penalty_block_mins INTEGER DEFAULT 0,
      early_departure_penalty_block_mins INTEGER DEFAULT 0,
      compulsory_ot_hours REAL DEFAULT 0,
      lunch_break_mins INTEGER DEFAULT 60,
      dinner_break_mins INTEGER DEFAULT 0,
      midnight_break_mins INTEGER DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (entity_id) REFERENCES entities(id),
      UNIQUE(entity_id, shift_name)
    )
  `);
}

function seedData(database) {
  const systemHash = bcrypt.hashSync('manager', 10);
  database.run(`INSERT INTO entities (name, uen, address, contact_number, website, email_domains) VALUES (?, ?, ?, ?, ?, ?)`, ['Hypex Pte Ltd', '202012345A', '123 Tech Lane, Singapore', '65432100', 'https://hypex.sg', 'hypex.com.sg, gmail.com, yahoo.com']);
  database.run(`INSERT INTO entities (name, uen, address, contact_number, website, email_domains) VALUES (?, ?, ?, ?, ?, ?)`, ['Samat Global', '202167890B', '456 Global Way, Singapore', '67890011', 'https://samat.com', 'samat.com, gmail.com']);

  database.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Admin', 'Full system access', JSON.stringify(['attendance:import:cross-entity'])]);
  database.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['HR', 'Human resources and payroll management', JSON.stringify(['attendance:import:cross-entity'])]);
  database.run(`INSERT INTO user_roles (name, description, permissions) VALUES (?, ?, ?)`, ['Operations Admin', 'Admin access to operations only. Restricted from Entity, Users, Roles masters.', JSON.stringify(['attendance:import:cross-entity'])]);

  database.run(`INSERT INTO users (username, password_hash, full_name) VALUES (?, ?, ?)`, ['system', systemHash, 'System Administrator']);
  database.run(`INSERT INTO user_entity_roles (user_id, entity_id, role, managed_groups) VALUES (?, ?, ?, ?)`, [1, 1, 'Admin', '[]']);
  database.run(`INSERT INTO user_entity_roles (user_id, entity_id, role, managed_groups) VALUES (?, ?, ?, ?)`, [1, 2, 'Admin', '[]']);
}

function seedConfigData(database) {
  // MOM-compliant leave types
  const leaveTypes = [
    ['Annual Leave', 7],
    ['Medical Leave', 14],
    ['Hospitalization Leave', 60],
    ['Childcare Leave', 6],
    ['Maternity Leave', 112],
    ['Paternity Leave', 24],
    ['Shared Parental Leave', 60],
    ['Compassionate Leave', 3],
    ['Unpaid Leave', 0],
    ['AWOL', 0]
  ];
  leaveTypes.forEach(([name, days]) => {
    database.run(`INSERT INTO leave_types (name, default_days) VALUES (?, ?)`, [name, days]);
  });
}

module.exports = { getDb, saveDb, reloadDb };
```
```diff:employees.js
const express = require('express');
const { getDb, saveDb } = require('../db/init');
const { authMiddleware } = require('../middleware/auth');
const multer = require('multer');
const XLSX = require('xlsx');

const upload = multer({ dest: 'uploads/temp/' });

// Photo storage configuration
const photoStorage = multer.diskStorage({
    destination: (req, file, cb) => {
        const dir = 'uploads/photos/';
        if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
        cb(null, dir);
    },
    filename: (req, file, cb) => {
        const ext = path.extname(file.originalname);
        cb(null, `emp_${Date.now()}${ext}`);
    }
});
const photoUpload = multer({ storage: photoStorage });

const router = express.Router();

const fs = require('fs');
const path = require('path');

// Helper to convert sql.js result to array of objects
function toObjects(result) {
    if (!result || !result.length) return [];
    const { columns, values } = result[0];
    return values.map(row => {
        const obj = {};
        columns.forEach((col, i) => obj[col] = row[i]);
        return obj;
    });
}

// GET /api/employees
router.get('/', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        let entityId = req.query.entityId || req.user.entityId;
        if (!entityId) return res.status(400).json({ error: 'Missing entity context' });

        const userId = req.user.id;
        const authSql = `SELECT uer.entity_id FROM user_entity_roles uer WHERE uer.user_id = ? AND uer.entity_id = ?`;
        const authRes = db.exec(authSql, [userId, entityId]);
        if (authRes.length === 0) {
            const roleSql = `SELECT role FROM user_entity_roles WHERE user_id = ? AND role = 'Admin' LIMIT 1`;
            const roleRes = db.exec(roleSql, [userId]);
            if (roleRes.length === 0) {
                return res.status(403).json({ error: 'Not authorized for this entity' });
            }
        }

        let query = 'SELECT * FROM employees WHERE entity_id = ?';
        const params = [entityId];

        // RBAC enforcement
        if (String(req.user.role).toUpperCase() === 'HR') {
            const groups = req.user.managedGroups || [];
            if (groups.length === 0) {
                return res.json([]);
            }
            const placeholders = groups.map(() => '?').join(',');
            query += ` AND employee_group IN (${placeholders})`;
            params.push(...groups);
        }

        query += ' ORDER BY employee_id';
        const result = db.exec(query, params);
        const emps = toObjects(result);
        res.json(emps);
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// PUT /api/employees/:id/face - Biometric Enrollment with Uniqueness Check
router.put('/:id/face', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const { descriptor } = req.body;
        const employeeId = req.params.id;
        const entityId = req.user.entityId;

        if (!descriptor) return res.status(400).json({ error: 'Missing descriptor' });

        // Anti-Duplication Check: Compare against all employees in the SAME entity
        const empsRes = db.exec('SELECT id, full_name, face_descriptor FROM employees WHERE entity_id = ? AND face_descriptor IS NOT NULL', [entityId]);
        const emps = toObjects(empsRes);

        console.log(`[FACE_REG] Checking uniqueness for employee ${employeeId} against ${emps.length} records`);

        const calculateDistance = (d1, d2) => Math.sqrt(d1.reduce((sum, val, i) => sum + Math.pow(val - d2[i], 2), 0));

        for (const emp of emps) {
            // Skip the employee we are currently enrolling (allow re-enrollment for same person)
            if (String(emp.id) === String(employeeId)) continue;

            try {
                const empDescriptor = JSON.parse(emp.face_descriptor);
                const distance = calculateDistance(descriptor, empDescriptor);

                // Logging for shared distance debugging
                if (distance < 0.8) {
                    console.log(`   - Potential match found with ${emp.full_name}, distance: ${distance.toFixed(4)}`);
                }

                if (distance < 0.6) { // Threshold for identifying same person
                    console.warn(`[FACE_REG] REJECTED: Face matches ${emp.full_name} (dist: ${distance.toFixed(4)})`);
                    return res.status(400).json({ error: `Face is already enrolled for ${emp.full_name}` });
                }
            } catch (e) { }
        }

        console.log(`[FACE_REG] SUCCESS: Saving face for employee ${employeeId}`);
        db.run('UPDATE employees SET face_descriptor = ? WHERE id = ?', [JSON.stringify(descriptor), employeeId]);
        saveDb();
        res.json({ message: 'Face descriptor saved' });
    } catch (err) {
        console.error('[FACE_REG_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// DELETE /api/employees/:id/face - Nullify Biometric Data
router.delete('/:id/face', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const employeeId = req.params.id;
        const entityId = req.user.entityId;

        console.log(`[FACE_RESET] Nullifying face for employee ${employeeId}`);
        db.run('UPDATE employees SET face_descriptor = NULL WHERE id = ? AND entity_id = ?', [employeeId, entityId]);
        saveDb();
        res.json({ message: 'Face biometric data reset successfully' });
    } catch (err) {
        console.error('[FACE_RESET_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// GET /api/employees/:id
router.get('/:id', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const entityId = req.user.entityId;
        if (!entityId) return res.status(400).json({ error: 'Missing entity context' });

        let query = 'SELECT e.*, en.name as entity_name, en.logo_url FROM employees e JOIN entities en ON e.entity_id = en.id WHERE e.id = ? AND e.entity_id = ?';
        const params = [req.params.id, entityId];

        if (String(req.user.role).toUpperCase() === 'HR') {
            const groups = req.user.managedGroups || [];
            if (groups.length === 0) return res.status(403).json({ error: 'Access denied' });

            const placeholders = groups.map(() => '?').join(',');
            query += ` AND employee_group IN (${placeholders})`;
            params.push(...groups);
        }

        const result = db.exec(query, params);
        const employees = toObjects(result);
        if (!employees.length) return res.status(404).json({ error: 'Employee not found or access denied' });
        res.json(employees[0]);
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// POST /api/employees
router.post('/', authMiddleware, photoUpload.single('photo'), async (req, res) => {
    try {
        const db = await getDb();
        const entityId = req.user.entityId;
        if (!entityId) return res.status(400).json({ error: 'Missing entity context' });

        const e = req.body;
        const photoUrl = req.file ? `/uploads/photos/${req.file.filename}` : null;

        const isResident = ['Citizen', 'PR'].includes(e.nationality);
        let warning = null;

        // ... validation check remains same ...

        // Check if national_id already exists in another entity to sync personal details
        if (e.national_id) {
            const existingResult = db.exec('SELECT * FROM employees WHERE national_id = ? LIMIT 1', [e.national_id]);
            const existing = toObjects(existingResult)[0];
            if (existing) {
                // Merge personal details from existing record if not provided in request
                e.full_name = e.full_name || existing.full_name;
                e.date_of_birth = e.date_of_birth || existing.date_of_birth;
                e.nationality = e.nationality || existing.nationality;
                e.tax_residency = e.tax_residency || existing.tax_residency;
                e.race = e.race || existing.race;
                e.gender = e.gender || existing.gender;
                e.language = e.language || existing.language;
                e.mobile_number = e.mobile_number || existing.mobile_number;
                e.whatsapp_number = e.whatsapp_number || existing.whatsapp_number;
                e.email = e.email || existing.email;
                e.highest_education = e.highest_education || existing.highest_education;
                e.photo_url = e.photo_url || existing.photo_url;
            }
        }

        db.run(
            `INSERT INTO employees (entity_id, employee_id, full_name, date_of_birth, national_id, nationality, tax_residency, race, gender, language, mobile_number, whatsapp_number, email, highest_education, designation, department, employee_group, employee_grade, date_joined, cessation_date, basic_salary, transport_allowance, meal_allowance, other_allowance, other_deduction, bank_name, bank_account, cpf_applicable, pr_status_start_date, cpf_full_rate_agreed, status, payment_mode, custom_allowances, custom_deductions, site_id, working_days_per_week, rest_day, working_hours_per_day, working_hours_per_week, photo_url) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
            [entityId || null, e.employee_id || '', e.full_name || '', e.date_of_birth || null, e.national_id || null, e.nationality || 'Singapore Citizen', e.tax_residency || 'Resident', e.race || 'Chinese', e.gender || '', e.language || '', e.mobile_number || '', e.whatsapp_number || '', e.email || '', e.highest_education || 'Others', e.designation || '', e.department || '', e.employee_group || 'General', e.employee_grade || '', e.date_joined || null, e.cessation_date || null, e.basic_salary || 0, e.transport_allowance || 0, e.meal_allowance || 0, e.other_allowance || 0, e.other_deduction || 0, e.bank_name || '', e.bank_account || '', e.cpf_applicable !== undefined ? e.cpf_applicable : 1, e.pr_status_start_date || null, e.cpf_full_rate_agreed !== undefined ? e.cpf_full_rate_agreed : 0, e.status || 'Active', e.payment_mode || 'Bank Transfer', e.custom_allowances || '{}', e.custom_deductions || '{}', e.site_id || null, e.working_days_per_week || 5.5, e.rest_day || 'Sunday', e.working_hours_per_day || 8, e.working_hours_per_week || 44, photoUrl || e.photo_url || null]
        );
        saveDb();

        const result = db.exec('SELECT * FROM employees WHERE employee_id = ? AND entity_id = ?', [e.employee_id, entityId]);
        const created = toObjects(result)[0];

        db.run(
            `INSERT INTO employee_kets (employee_id, job_title, employment_start_date, basic_salary, fixed_allowances, working_days_per_week, rest_day, working_hours_per_day) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
            [created.id, e.designation || 'Employee', e.date_joined || new Date().toISOString().split('T')[0], e.basic_salary || 0,
            JSON.stringify({ transport: e.transport_allowance || 0, meal: e.meal_allowance || 0 }),
            e.working_days_per_week || 5.5, e.rest_day || 'Sunday', e.working_hours_per_day || 8]
        );

        const leaveTypesResult = db.exec('SELECT * FROM leave_types');
        const types = toObjects(leaveTypesResult);
        const year = new Date().getFullYear();
        types.forEach(lt => {
            db.run(`INSERT INTO leave_balances (employee_id, leave_type_id, year, entitled, taken, balance) VALUES (?, ?, ?, ?, 0, ?)`,
                [created.id, lt.id, year, lt.default_days, lt.default_days]);
        });
        saveDb();
        res.status(201).json({ ...created, warning });
    } catch (err) {
        console.error('[POST_EMPLOYEE_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// PUT /api/employees/:id
router.put('/:id', authMiddleware, photoUpload.single('photo'), async (req, res) => {
    try {
        const db = await getDb();
        const entityId = req.user.entityId;
        const e = req.body;
        const photoUrl = req.file ? `/uploads/photos/${req.file.filename}` : (e.photo_url || null);

        db.run(
            `UPDATE employees SET employee_id=?, full_name=?, date_of_birth=?, national_id=?, nationality=?, tax_residency=?, race=?, gender=?, language=?, mobile_number=?, whatsapp_number=?, email=?, highest_education=?, designation=?, department=?, employee_group=?, employee_grade=?, date_joined=?, cessation_date=?, basic_salary=?, transport_allowance=?, meal_allowance=?, other_allowance=?, other_deduction=?, bank_name=?, bank_account=?, cpf_applicable=?, pr_status_start_date=?, cpf_full_rate_agreed=?, status=?, payment_mode=?, custom_allowances=?, custom_deductions=?, site_id=?, working_days_per_week=?, rest_day=?, working_hours_per_day=?, working_hours_per_week=?, photo_url=? WHERE id=? AND entity_id=?`,
            [e.employee_id || '', e.full_name || '', e.date_of_birth || null, e.national_id || null, e.nationality || 'Singapore Citizen', e.tax_residency || 'Resident', e.race || 'Chinese', e.gender || '', e.language || '', e.mobile_number || '', e.whatsapp_number || '', e.email || '', e.highest_education || 'Others', e.designation || '', e.department || '', e.employee_group || 'General', e.employee_grade || '', e.date_joined || null, e.cessation_date || null, e.basic_salary || 0, e.transport_allowance || 0, e.meal_allowance || 0, e.other_allowance || 0, e.other_deduction || 0, e.bank_name || '', e.bank_account || '', e.cpf_applicable !== undefined ? e.cpf_applicable : 1, e.pr_status_start_date || null, e.cpf_full_rate_agreed !== undefined ? e.cpf_full_rate_agreed : 0, e.status || 'Active', e.payment_mode || 'Bank Transfer', e.custom_allowances || '{}', e.custom_deductions || '{}', e.site_id || null, e.working_days_per_week || 5.5, e.rest_day || 'Sunday', e.working_hours_per_day || 8, e.working_hours_per_week || 44, photoUrl || null, req.params.id || null, entityId || null]
        );

        // SYNC: Update personal details across all other entities for same national_id
        if (e.national_id) {
            db.run(
                `UPDATE employees SET full_name=?, date_of_birth=?, nationality=?, tax_residency=?, race=?, gender=?, language=?, mobile_number=?, whatsapp_number=?, email=?, highest_education=?, photo_url=? WHERE national_id = ? AND entity_id != ?`,
                [e.full_name || '', e.date_of_birth || null, e.nationality || 'Singapore Citizen', e.tax_residency || 'Resident', e.race || 'Chinese', e.gender || '', e.language || '', e.mobile_number || '', e.whatsapp_number || '', e.email || '', e.highest_education || 'Others', photoUrl || null, e.national_id, entityId]
            );
        }

        saveDb();
        const result = db.exec('SELECT * FROM employees WHERE id = ?', [req.params.id]);
        res.json(toObjects(result)[0]);
    } catch (err) {
        console.error('[PUT_EMPLOYEE_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// DELETE /api/employees/:id
router.delete('/:id', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        db.run('DELETE FROM employee_kets WHERE employee_id = ?', [req.params.id]);
        db.run('DELETE FROM leave_balances WHERE employee_id = ?', [req.params.id]);
        db.run('DELETE FROM leave_requests WHERE employee_id = ?', [req.params.id]);
        db.run('DELETE FROM employees WHERE id = ?', [req.params.id]);
        saveDb();
        res.json({ message: 'Employee deleted' });
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// POST /api/employees/:id/transfer
router.post('/:id/transfer', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const currentEntityId = req.user.entityId;
        const { targetEntityId } = req.body;
        db.exec('BEGIN TRANSACTION');
        try {
            const empResult = db.exec('SELECT * FROM employees WHERE id = ? AND entity_id = ?', [req.params.id, currentEntityId]);
            const emp = toObjects(empResult)[0];
            db.run(
                `INSERT INTO employees (entity_id, employee_id, full_name, date_of_birth, national_id, nationality, tax_residency, race, gender, language, mobile_number, whatsapp_number, email, highest_education, designation, department, employee_group, employee_grade, date_joined, basic_salary, transport_allowance, meal_allowance, other_allowance, other_deduction, bank_name, bank_account, cpf_applicable, status, payment_mode, custom_allowances, custom_deductions, site_id) 
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                [targetEntityId, emp.employee_id || '', emp.full_name || '', emp.date_of_birth || null, emp.national_id || null, emp.nationality || 'Singapore Citizen', emp.tax_residency || 'Resident', emp.race || 'Chinese', emp.gender || '', emp.language || '', emp.mobile_number || '', emp.whatsapp_number || '', emp.email || '', emp.highest_education || 'Others', emp.designation || '', emp.department || '', emp.employee_group || 'General', emp.employee_grade || '', emp.date_joined || null, emp.basic_salary || 0, emp.transport_allowance || 0, emp.meal_allowance || 0, emp.other_allowance || 0, emp.other_deduction || 0, emp.bank_name || '', emp.bank_account || '', emp.cpf_applicable !== undefined ? emp.cpf_applicable : 1, 'Active', emp.payment_mode || 'Bank Transfer', emp.custom_allowances || '{}', emp.custom_deductions || '{}', emp.site_id || null]
            );
            const newEmpId = db.exec(`SELECT last_insert_rowid() AS id`)[0].values[0][0];
            db.run('UPDATE employees SET status = \'Transferred\' WHERE id = ?', [emp.id]);
            db.exec('COMMIT');
            saveDb();
            res.json({ message: 'Employee transferred', newId: newEmpId });
        } catch (err) { db.exec('ROLLBACK'); throw err; }
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// POST /api/employees/bulk-custom
router.post('/bulk-custom', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const { records } = req.body;
        if (!Array.isArray(records)) {
            return res.status(400).json({ error: 'Invalid input: records must be an array' });
        }
        db.exec('BEGIN TRANSACTION');
        try {
            records.forEach(rc => {
                if (!rc.id) return;
                db.run(`UPDATE employees SET custom_allowances = ?, custom_deductions = ? WHERE id = ? AND entity_id = ?`,
                    [JSON.stringify(rc.custom_allowances || {}), JSON.stringify(rc.custom_deductions || {}), rc.id, req.user.entityId]);
            });
            db.exec('COMMIT');
            saveDb();
            res.json({ message: 'Bulk modifiers applied' });
        } catch (err) { db.exec('ROLLBACK'); throw err; }
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// POST /api/employees/bulk-import
router.post('/bulk-import', authMiddleware, upload.single('file'), async (req, res) => {
    try {
        const db = await getDb();
        if (!req.file) return res.status(400).json({ error: 'No file uploaded' });
        const workbook = XLSX.readFile(req.file.path);
        const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        const results = { processed: 0, skipped: 0, errors: [] };
        db.exec('BEGIN TRANSACTION');
        try {
            for (const row of data) {
                const e = {
                    employee_id: String(row['Employee ID'] || row['employee_id'] || ''),
                    full_name: row['Full Name'] || row['full_name'] || '',
                    national_id: row['National ID'] || row['national_id'] || '',
                    nationality: row['Nationality'] || row['nationality'] || 'Citizen',
                    basic_salary: parseFloat(row['Basic Salary'] || row['basic_salary'] || 0),
                    employee_group: row['Employee Group'] || row['employee_group'] || 'General',
                    gender: row['Gender'] || row['gender'] || '',
                    date_of_birth: row['Date of Birth'] || row['date_of_birth'] || '',
                    phone: row['Phone'] || row['phone'] || '',
                    email: row['Email'] || row['email'] || '',
                    address: row['Address'] || row['address'] || '',
                    bank_name: row['Bank Name'] || row['bank_name'] || '',
                    bank_account: row['Bank Account'] || row['bank_account'] || '',
                    working_days_per_week: parseFloat(row['Working Days/Week'] || row['working_days_per_week'] || 5.5),
                    rest_day: row['Rest Day'] || row['rest_day'] || 'Sunday',
                    working_hours_per_day: parseFloat(row['Working Hours/Day'] || row['working_hours_per_day'] || 8),
                    working_hours_per_week: parseFloat(row['Working Hours/Week'] || row['working_hours_per_week'] || 44),
                    other_deduction: parseFloat(row['Other Deduction'] || row['other_deduction'] || 0),
                    status: row['Status'] || row['status'] || 'Active',
                    cessation_date: row['Cessation Date'] || row['cessation_date'] || null,
                    pr_status_start_date: row['PR Start Date'] || row['pr_status_start_date'] || null,
                };
                if (!e.full_name || !e.employee_id) { results.skipped++; continue; }

                // Use REPLACE INTO or check for existence? 
                // Let's use a check to avoid duplicates or optionally update
                const existing = db.exec('SELECT id FROM employees WHERE entity_id = ? AND employee_id = ?', [req.user.entityId, e.employee_id]);

                if (existing.length > 0 && existing[0].values.length > 0) {
                    const id = existing[0].values[0][0];
                    db.run(`UPDATE employees SET 
                        full_name = ?, national_id = ?, nationality = ?, basic_salary = ?, 
                        employee_group = ?, gender = ?, date_of_birth = ?, phone = ?, email = ?, address = ?, 
                        bank_name = ?, bank_account = ?, working_days_per_week = ?, rest_day = ?, 
                        working_hours_per_day = ?, working_hours_per_week = ?, other_deduction = ?, 
                        status = ?, cessation_date = ?, pr_status_start_date = ?
                        WHERE id = ?`,
                        [e.full_name, e.national_id, e.nationality, e.basic_salary,
                        e.employee_group, e.gender, e.date_of_birth, e.phone, e.email, e.address,
                        e.bank_name, e.bank_account, e.working_days_per_week, e.rest_day,
                        e.working_hours_per_day, e.working_hours_per_week, e.other_deduction,
                        e.status, e.cessation_date, e.pr_status_start_date, id]);
                } else {
                    db.run(`INSERT INTO employees (
                        entity_id, employee_id, full_name, national_id, nationality, basic_salary, 
                        employee_group, gender, date_of_birth, phone, email, address, 
                        bank_name, bank_account, working_days_per_week, rest_day, 
                        working_hours_per_day, working_hours_per_week, other_deduction, 
                        status, cessation_date, pr_status_start_date
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                        [req.user.entityId, e.employee_id, e.full_name, e.national_id, e.nationality, e.basic_salary,
                        e.employee_group, e.gender, e.date_of_birth, e.phone, e.email, e.address,
                        e.bank_name, e.bank_account, e.working_days_per_week, e.rest_day,
                        e.working_hours_per_day, e.working_hours_per_week, e.other_deduction,
                        e.status, e.cessation_date, e.pr_status_start_date]);
                }
                results.processed++;
            }
            db.exec('COMMIT');
            saveDb();
            res.json({ message: 'Import completed', ...results });
        } catch (err) { db.exec('ROLLBACK'); throw err; }
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// JSON 404 handler for employees router
router.use((req, res) => {
    res.status(404).json({ error: `Route ${req.method} ${req.originalUrl} not found in employees router` });
});

module.exports = router;
===
const express = require('express');
const { getDb, saveDb } = require('../db/init');
const { authMiddleware } = require('../middleware/auth');
const multer = require('multer');
const XLSX = require('xlsx');

const upload = multer({ dest: 'uploads/temp/' });

// Photo storage configuration
const photoStorage = multer.diskStorage({
    destination: (req, file, cb) => {
        const dir = 'uploads/photos/';
        if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
        cb(null, dir);
    },
    filename: (req, file, cb) => {
        const ext = path.extname(file.originalname);
        cb(null, `emp_${Date.now()}${ext}`);
    }
});
const photoUpload = multer({ storage: photoStorage });

const router = express.Router();

const fs = require('fs');
const path = require('path');

// Helper to convert sql.js result to array of objects
function toObjects(result) {
    if (!result || !result.length) return [];
    const { columns, values } = result[0];
    return values.map(row => {
        const obj = {};
        columns.forEach((col, i) => obj[col] = row[i]);
        return obj;
    });
}

// GET /api/employees
router.get('/', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        let entityId = req.query.entityId || req.user.entityId;
        if (!entityId) return res.status(400).json({ error: 'Missing entity context' });

        const userId = req.user.id;
        const authSql = `SELECT uer.entity_id FROM user_entity_roles uer WHERE uer.user_id = ? AND uer.entity_id = ?`;
        const authRes = db.exec(authSql, [userId, entityId]);
        if (authRes.length === 0) {
            const roleSql = `SELECT role FROM user_entity_roles WHERE user_id = ? AND role = 'Admin' LIMIT 1`;
            const roleRes = db.exec(roleSql, [userId]);
            if (roleRes.length === 0) {
                return res.status(403).json({ error: 'Not authorized for this entity' });
            }
        }

        let query = 'SELECT * FROM employees WHERE entity_id = ?';
        const params = [entityId];

        // RBAC enforcement
        if (String(req.user.role).toUpperCase() === 'HR') {
            const groups = req.user.managedGroups || [];
            if (groups.length === 0) {
                return res.json([]);
            }
            const placeholders = groups.map(() => '?').join(',');
            query += ` AND employee_group IN (${placeholders})`;
            params.push(...groups);
        }

        query += ' ORDER BY employee_id';
        const result = db.exec(query, params);
        const emps = toObjects(result);
        res.json(emps);
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// PUT /api/employees/:id/face - Biometric Enrollment with Uniqueness Check
router.put('/:id/face', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const { descriptor } = req.body;
        const employeeId = req.params.id;
        const entityId = req.user.entityId;

        if (!descriptor) return res.status(400).json({ error: 'Missing descriptor' });

        // Anti-Duplication Check: Compare against all employees in the SAME entity
        const empsRes = db.exec('SELECT id, full_name, face_descriptor FROM employees WHERE entity_id = ? AND face_descriptor IS NOT NULL', [entityId]);
        const emps = toObjects(empsRes);

        console.log(`[FACE_REG] Checking uniqueness for employee ${employeeId} against ${emps.length} records`);

        const calculateDistance = (d1, d2) => Math.sqrt(d1.reduce((sum, val, i) => sum + Math.pow(val - d2[i], 2), 0));

        for (const emp of emps) {
            // Skip the employee we are currently enrolling (allow re-enrollment for same person)
            if (String(emp.id) === String(employeeId)) continue;

            try {
                const empDescriptor = JSON.parse(emp.face_descriptor);
                const distance = calculateDistance(descriptor, empDescriptor);

                // Logging for shared distance debugging
                if (distance < 0.8) {
                    console.log(`   - Potential match found with ${emp.full_name}, distance: ${distance.toFixed(4)}`);
                }

                if (distance < 0.6) { // Threshold for identifying same person
                    console.warn(`[FACE_REG] REJECTED: Face matches ${emp.full_name} (dist: ${distance.toFixed(4)})`);
                    return res.status(400).json({ error: `Face is already enrolled for ${emp.full_name}` });
                }
            } catch (e) { }
        }

        console.log(`[FACE_REG] SUCCESS: Saving face for employee ${employeeId}`);
        db.run('UPDATE employees SET face_descriptor = ? WHERE id = ?', [JSON.stringify(descriptor), employeeId]);
        saveDb();
        res.json({ message: 'Face descriptor saved' });
    } catch (err) {
        console.error('[FACE_REG_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// DELETE /api/employees/:id/face - Nullify Biometric Data
router.delete('/:id/face', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const employeeId = req.params.id;
        const entityId = req.user.entityId;

        console.log(`[FACE_RESET] Nullifying face for employee ${employeeId}`);
        db.run('UPDATE employees SET face_descriptor = NULL WHERE id = ? AND entity_id = ?', [employeeId, entityId]);
        saveDb();
        res.json({ message: 'Face biometric data reset successfully' });
    } catch (err) {
        console.error('[FACE_RESET_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// GET /api/employees/:id
router.get('/:id', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const entityId = req.user.entityId;
        if (!entityId) return res.status(400).json({ error: 'Missing entity context' });

        let query = 'SELECT e.*, en.name as entity_name, en.logo_url FROM employees e JOIN entities en ON e.entity_id = en.id WHERE e.id = ? AND e.entity_id = ?';
        const params = [req.params.id, entityId];

        if (String(req.user.role).toUpperCase() === 'HR') {
            const groups = req.user.managedGroups || [];
            if (groups.length === 0) return res.status(403).json({ error: 'Access denied' });

            const placeholders = groups.map(() => '?').join(',');
            query += ` AND employee_group IN (${placeholders})`;
            params.push(...groups);
        }

        const result = db.exec(query, params);
        const employees = toObjects(result);
        if (!employees.length) return res.status(404).json({ error: 'Employee not found or access denied' });
        res.json(employees[0]);
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// POST /api/employees
router.post('/', authMiddleware, photoUpload.single('photo'), async (req, res) => {
    try {
        const db = await getDb();
        const entityId = req.user.entityId;
        if (!entityId) return res.status(400).json({ error: 'Missing entity context' });

        const e = req.body;
        const photoUrl = req.file ? `/uploads/photos/${req.file.filename}` : null;

        const isResident = ['Citizen', 'PR'].includes(e.nationality);
        let warning = null;

        // ... validation check remains same ...

        // Check if national_id already exists in another entity to sync personal details
        if (e.national_id) {
            const existingResult = db.exec('SELECT * FROM employees WHERE national_id = ? LIMIT 1', [e.national_id]);
            const existing = toObjects(existingResult)[0];
            if (existing) {
                // Merge personal details from existing record if not provided in request
                e.full_name = e.full_name || existing.full_name;
                e.date_of_birth = e.date_of_birth || existing.date_of_birth;
                e.nationality = e.nationality || existing.nationality;
                e.tax_residency = e.tax_residency || existing.tax_residency;
                e.race = e.race || existing.race;
                e.gender = e.gender || existing.gender;
                e.language = e.language || existing.language;
                e.mobile_number = e.mobile_number || existing.mobile_number;
                e.whatsapp_number = e.whatsapp_number || existing.whatsapp_number;
                e.email = e.email || existing.email;
                e.highest_education = e.highest_education || existing.highest_education;
                e.photo_url = e.photo_url || existing.photo_url;
            }
        }

        db.run(
            `INSERT INTO employees (entity_id, employee_id, full_name, date_of_birth, national_id, nationality, tax_residency, race, gender, language, mobile_number, whatsapp_number, email, highest_education, designation, department, employee_group, employee_grade, date_joined, cessation_date, basic_salary, transport_allowance, meal_allowance, other_allowance, other_deduction, bank_name, bank_account, cpf_applicable, pr_status_start_date, cpf_full_rate_agreed, status, payment_mode, custom_allowances, custom_deductions, site_id, working_days_per_week, rest_day, working_hours_per_day, working_hours_per_week, photo_url, work_pass_type, work_pass_expiry) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
            [entityId || null, e.employee_id || '', e.full_name || '', e.date_of_birth || null, e.national_id || null, e.nationality || 'Singapore Citizen', e.tax_residency || 'Resident', e.race || 'Chinese', e.gender || '', e.language || '', e.mobile_number || '', e.whatsapp_number || '', e.email || '', e.highest_education || 'Others', e.designation || '', e.department || '', e.employee_group || 'General', e.employee_grade || '', e.date_joined || null, e.cessation_date || null, e.basic_salary || 0, e.transport_allowance || 0, e.meal_allowance || 0, e.other_allowance || 0, e.other_deduction || 0, e.bank_name || '', e.bank_account || '', e.cpf_applicable !== undefined ? e.cpf_applicable : 1, e.pr_status_start_date || null, e.cpf_full_rate_agreed !== undefined ? e.cpf_full_rate_agreed : 0, e.status || 'Active', e.payment_mode || 'Bank Transfer', e.custom_allowances || '{}', e.custom_deductions || '{}', e.site_id || null, e.working_days_per_week || 5.5, e.rest_day || 'Sunday', e.working_hours_per_day || 8, e.working_hours_per_week || 44, photoUrl || e.photo_url || null, e.work_pass_type || null, e.work_pass_expiry || null]
        );
        saveDb();

        const result = db.exec('SELECT * FROM employees WHERE employee_id = ? AND entity_id = ?', [e.employee_id, entityId]);
        const created = toObjects(result)[0];

        db.run(
            `INSERT INTO employee_kets (employee_id, job_title, employment_start_date, basic_salary, fixed_allowances, working_days_per_week, rest_day, working_hours_per_day) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
            [created.id, e.designation || 'Employee', e.date_joined || new Date().toISOString().split('T')[0], e.basic_salary || 0,
            JSON.stringify({ transport: e.transport_allowance || 0, meal: e.meal_allowance || 0 }),
            e.working_days_per_week || 5.5, e.rest_day || 'Sunday', e.working_hours_per_day || 8]
        );

        const leaveTypesResult = db.exec('SELECT * FROM leave_types');
        const types = toObjects(leaveTypesResult);
        const year = new Date().getFullYear();
        types.forEach(lt => {
            db.run(`INSERT INTO leave_balances (employee_id, leave_type_id, year, entitled, taken, balance) VALUES (?, ?, ?, ?, 0, ?)`,
                [created.id, lt.id, year, lt.default_days, lt.default_days]);
        });
        saveDb();
        res.status(201).json({ ...created, warning });
    } catch (err) {
        console.error('[POST_EMPLOYEE_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// PUT /api/employees/:id
router.put('/:id', authMiddleware, photoUpload.single('photo'), async (req, res) => {
    try {
        const db = await getDb();
        const entityId = req.user.entityId;
        const e = req.body;
        const photoUrl = req.file ? `/uploads/photos/${req.file.filename}` : (e.photo_url || null);

        db.run(
            `UPDATE employees SET employee_id=?, full_name=?, date_of_birth=?, national_id=?, nationality=?, tax_residency=?, race=?, gender=?, language=?, mobile_number=?, whatsapp_number=?, email=?, highest_education=?, designation=?, department=?, employee_group=?, employee_grade=?, date_joined=?, cessation_date=?, basic_salary=?, transport_allowance=?, meal_allowance=?, other_allowance=?, other_deduction=?, bank_name=?, bank_account=?, cpf_applicable=?, pr_status_start_date=?, cpf_full_rate_agreed=?, status=?, payment_mode=?, custom_allowances=?, custom_deductions=?, site_id=?, working_days_per_week=?, rest_day=?, working_hours_per_day=?, working_hours_per_week=?, photo_url=?, work_pass_type=?, work_pass_expiry=? WHERE id=? AND entity_id=?`,
            [e.employee_id || '', e.full_name || '', e.date_of_birth || null, e.national_id || null, e.nationality || 'Singapore Citizen', e.tax_residency || 'Resident', e.race || 'Chinese', e.gender || '', e.language || '', e.mobile_number || '', e.whatsapp_number || '', e.email || '', e.highest_education || 'Others', e.designation || '', e.department || '', e.employee_group || 'General', e.employee_grade || '', e.date_joined || null, e.cessation_date || null, e.basic_salary || 0, e.transport_allowance || 0, e.meal_allowance || 0, e.other_allowance || 0, e.other_deduction || 0, e.bank_name || '', e.bank_account || '', e.cpf_applicable !== undefined ? e.cpf_applicable : 1, e.pr_status_start_date || null, e.cpf_full_rate_agreed !== undefined ? e.cpf_full_rate_agreed : 0, e.status || 'Active', e.payment_mode || 'Bank Transfer', e.custom_allowances || '{}', e.custom_deductions || '{}', e.site_id || null, e.working_days_per_week || 5.5, e.rest_day || 'Sunday', e.working_hours_per_day || 8, e.working_hours_per_week || 44, photoUrl || null, e.work_pass_type || null, e.work_pass_expiry || null, req.params.id || null, entityId || null]
        );

        // SYNC: Update personal details across all other entities for same national_id
        if (e.national_id) {
            db.run(
                `UPDATE employees SET full_name=?, date_of_birth=?, nationality=?, tax_residency=?, race=?, gender=?, language=?, mobile_number=?, whatsapp_number=?, email=?, highest_education=?, photo_url=? WHERE national_id = ? AND entity_id != ?`,
                [e.full_name || '', e.date_of_birth || null, e.nationality || 'Singapore Citizen', e.tax_residency || 'Resident', e.race || 'Chinese', e.gender || '', e.language || '', e.mobile_number || '', e.whatsapp_number || '', e.email || '', e.highest_education || 'Others', photoUrl || null, e.national_id, entityId]
            );
        }

        saveDb();
        const result = db.exec('SELECT * FROM employees WHERE id = ?', [req.params.id]);
        res.json(toObjects(result)[0]);
    } catch (err) {
        console.error('[PUT_EMPLOYEE_ERROR]', err);
        res.status(500).json({ error: err.message });
    }
});

// DELETE /api/employees/:id
router.delete('/:id', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        db.run('DELETE FROM employee_kets WHERE employee_id = ?', [req.params.id]);
        db.run('DELETE FROM leave_balances WHERE employee_id = ?', [req.params.id]);
        db.run('DELETE FROM leave_requests WHERE employee_id = ?', [req.params.id]);
        db.run('DELETE FROM employees WHERE id = ?', [req.params.id]);
        saveDb();
        res.json({ message: 'Employee deleted' });
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// POST /api/employees/:id/transfer
router.post('/:id/transfer', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const currentEntityId = req.user.entityId;
        const { targetEntityId } = req.body;
        db.exec('BEGIN TRANSACTION');
        try {
            const empResult = db.exec('SELECT * FROM employees WHERE id = ? AND entity_id = ?', [req.params.id, currentEntityId]);
            const emp = toObjects(empResult)[0];
            db.run(
                `INSERT INTO employees (entity_id, employee_id, full_name, date_of_birth, national_id, nationality, tax_residency, race, gender, language, mobile_number, whatsapp_number, email, highest_education, designation, department, employee_group, employee_grade, date_joined, basic_salary, transport_allowance, meal_allowance, other_allowance, other_deduction, bank_name, bank_account, cpf_applicable, status, payment_mode, custom_allowances, custom_deductions, site_id) 
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                [targetEntityId, emp.employee_id || '', emp.full_name || '', emp.date_of_birth || null, emp.national_id || null, emp.nationality || 'Singapore Citizen', emp.tax_residency || 'Resident', emp.race || 'Chinese', emp.gender || '', emp.language || '', emp.mobile_number || '', emp.whatsapp_number || '', emp.email || '', emp.highest_education || 'Others', emp.designation || '', emp.department || '', emp.employee_group || 'General', emp.employee_grade || '', emp.date_joined || null, emp.basic_salary || 0, emp.transport_allowance || 0, emp.meal_allowance || 0, emp.other_allowance || 0, emp.other_deduction || 0, emp.bank_name || '', emp.bank_account || '', emp.cpf_applicable !== undefined ? emp.cpf_applicable : 1, 'Active', emp.payment_mode || 'Bank Transfer', emp.custom_allowances || '{}', emp.custom_deductions || '{}', emp.site_id || null]
            );
            const newEmpId = db.exec(`SELECT last_insert_rowid() AS id`)[0].values[0][0];
            db.run('UPDATE employees SET status = \'Transferred\' WHERE id = ?', [emp.id]);
            db.exec('COMMIT');
            saveDb();
            res.json({ message: 'Employee transferred', newId: newEmpId });
        } catch (err) { db.exec('ROLLBACK'); throw err; }
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// POST /api/employees/bulk-custom
router.post('/bulk-custom', authMiddleware, async (req, res) => {
    try {
        const db = await getDb();
        const { records } = req.body;
        if (!Array.isArray(records)) {
            return res.status(400).json({ error: 'Invalid input: records must be an array' });
        }
        db.exec('BEGIN TRANSACTION');
        try {
            records.forEach(rc => {
                if (!rc.id) return;
                db.run(`UPDATE employees SET custom_allowances = ?, custom_deductions = ? WHERE id = ? AND entity_id = ?`,
                    [JSON.stringify(rc.custom_allowances || {}), JSON.stringify(rc.custom_deductions || {}), rc.id, req.user.entityId]);
            });
            db.exec('COMMIT');
            saveDb();
            res.json({ message: 'Bulk modifiers applied' });
        } catch (err) { db.exec('ROLLBACK'); throw err; }
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// POST /api/employees/bulk-import
router.post('/bulk-import', authMiddleware, upload.single('file'), async (req, res) => {
    try {
        const db = await getDb();
        if (!req.file) return res.status(400).json({ error: 'No file uploaded' });
        const workbook = XLSX.readFile(req.file.path);
        const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        const results = { processed: 0, skipped: 0, errors: [] };
        db.exec('BEGIN TRANSACTION');
        try {
            for (const row of data) {
                const e = {
                    employee_id: String(row['Employee ID'] || row['employee_id'] || ''),
                    full_name: row['Full Name'] || row['full_name'] || '',
                    national_id: row['National ID'] || row['national_id'] || '',
                    nationality: row['Nationality'] || row['nationality'] || 'Citizen',
                    basic_salary: parseFloat(row['Basic Salary'] || row['basic_salary'] || 0),
                    employee_group: row['Employee Group'] || row['employee_group'] || 'General',
                    gender: row['Gender'] || row['gender'] || '',
                    date_of_birth: row['Date of Birth'] || row['date_of_birth'] || '',
                    phone: row['Phone'] || row['phone'] || '',
                    email: row['Email'] || row['email'] || '',
                    address: row['Address'] || row['address'] || '',
                    bank_name: row['Bank Name'] || row['bank_name'] || '',
                    bank_account: row['Bank Account'] || row['bank_account'] || '',
                    working_days_per_week: parseFloat(row['Working Days/Week'] || row['working_days_per_week'] || 5.5),
                    rest_day: row['Rest Day'] || row['rest_day'] || 'Sunday',
                    working_hours_per_day: parseFloat(row['Working Hours/Day'] || row['working_hours_per_day'] || 8),
                    working_hours_per_week: parseFloat(row['Working Hours/Week'] || row['working_hours_per_week'] || 44),
                    other_deduction: parseFloat(row['Other Deduction'] || row['other_deduction'] || 0),
                    status: row['Status'] || row['status'] || 'Active',
                    cessation_date: row['Cessation Date'] || row['cessation_date'] || null,
                    pr_status_start_date: row['PR Start Date'] || row['pr_status_start_date'] || null,
                };
                if (!e.full_name || !e.employee_id) { results.skipped++; continue; }

                // Use REPLACE INTO or check for existence? 
                // Let's use a check to avoid duplicates or optionally update
                const existing = db.exec('SELECT id FROM employees WHERE entity_id = ? AND employee_id = ?', [req.user.entityId, e.employee_id]);

                if (existing.length > 0 && existing[0].values.length > 0) {
                    const id = existing[0].values[0][0];
                    db.run(`UPDATE employees SET 
                        full_name = ?, national_id = ?, nationality = ?, basic_salary = ?, 
                        employee_group = ?, gender = ?, date_of_birth = ?, phone = ?, email = ?, address = ?, 
                        bank_name = ?, bank_account = ?, working_days_per_week = ?, rest_day = ?, 
                        working_hours_per_day = ?, working_hours_per_week = ?, other_deduction = ?, 
                        status = ?, cessation_date = ?, pr_status_start_date = ?
                        WHERE id = ?`,
                        [e.full_name, e.national_id, e.nationality, e.basic_salary,
                        e.employee_group, e.gender, e.date_of_birth, e.phone, e.email, e.address,
                        e.bank_name, e.bank_account, e.working_days_per_week, e.rest_day,
                        e.working_hours_per_day, e.working_hours_per_week, e.other_deduction,
                        e.status, e.cessation_date, e.pr_status_start_date, id]);
                } else {
                    db.run(`INSERT INTO employees (
                        entity_id, employee_id, full_name, national_id, nationality, basic_salary, 
                        employee_group, gender, date_of_birth, phone, email, address, 
                        bank_name, bank_account, working_days_per_week, rest_day, 
                        working_hours_per_day, working_hours_per_week, other_deduction, 
                        status, cessation_date, pr_status_start_date
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                        [req.user.entityId, e.employee_id, e.full_name, e.national_id, e.nationality, e.basic_salary,
                        e.employee_group, e.gender, e.date_of_birth, e.phone, e.email, e.address,
                        e.bank_name, e.bank_account, e.working_days_per_week, e.rest_day,
                        e.working_hours_per_day, e.working_hours_per_week, e.other_deduction,
                        e.status, e.cessation_date, e.pr_status_start_date]);
                }
                results.processed++;
            }
            db.exec('COMMIT');
            saveDb();
            res.json({ message: 'Import completed', ...results });
        } catch (err) { db.exec('ROLLBACK'); throw err; }
    } catch (err) { res.status(500).json({ error: err.message }); }
});

// JSON 404 handler for employees router
router.use((req, res) => {
    res.status(404).json({ error: `Route ${req.method} ${req.originalUrl} not found in employees router` });
});

module.exports = router;
```
```diff:EmployeeForm.jsx
import { useState, useEffect, useRef } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { useAuth } from '../context/AuthContext'
import toast from 'react-hot-toast'
import api from '../services/api'
import DatePicker from '../components/DatePicker'

const emptyEmployee = {
    employee_id: '', full_name: '', date_of_birth: '', national_id: '', nationality: 'Singapore Citizen',
    tax_residency: 'Resident', race: 'Chinese', gender: 'Male', language: 'English', mobile_number: '', whatsapp_number: '', email: '', highest_education: '', designation: '', department: '', employee_group: 'General', employee_grade: '', site_id: '',
    date_joined: '', cessation_date: '', basic_salary: 0, transport_allowance: 0, meal_allowance: 0,
    other_allowance: 0, payment_mode: 'Bank Transfer', custom_allowances: '{}', custom_deductions: '{}',
    bank_name: '', bank_account: '', cpf_applicable: 0,
    pr_status_start_date: '', cpf_full_rate_agreed: 0,
    working_days_per_week: 5.5, rest_day: 'Sunday',
    working_hours_per_day: 8, working_hours_per_week: 44,
    status: 'Active', photo_url: null,
    other_deduction: 0,
    _parsedCustomAllowances: [], _parsedCustomDeductions: []
}

const Field = ({ label, name, type = 'text', options, required, span2, form, setForm, min, max }) => (
    <div className={span2 ? 'md:col-span-2' : ''}>
        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">
            {label} {required && <span className="text-rose-500">*</span>}
        </label>
        {options ? (
            <select value={form[name]} onChange={e => setForm({ ...form, [name]: e.target.value })} className="select-base" required={required}>
                {options.map(o => <option key={o} value={o}>{o}</option>)}
            </select>
        ) : (
            <input
                type={type}
                value={form[name] || ''}
                onChange={e => setForm({ ...form, [name]: type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value })}
                className="input-base"
                required={required}
                step={type === 'number' ? '0.01' : undefined}
            />
        )}
    </div>
)

export default function EmployeeForm() {
    const { id } = useParams()
    const navigate = useNavigate()
    const { activeEntity } = useAuth()
    const isEditing = Boolean(id)
    const fileInputRef = useRef(null)

    const [loading, setLoading] = useState(isEditing)
    const [submitting, setSubmitting] = useState(false)
    const [form, setForm] = useState(emptyEmployee)
    const [documents, setDocuments] = useState([])
    const [photoFile, setPhotoFile] = useState(null)
    const [photoPreview, setPhotoPreview] = useState(null)

    // Config data
    const [configDepartments, setConfigDepartments] = useState([])
    const [configGroups, setConfigGroups] = useState([])
    const [configGrades, setConfigGrades] = useState([])
    const [configSites, setConfigSites] = useState([])

    const [emailDomains, setEmailDomains] = useState([])

    useEffect(() => {
        if (!activeEntity) return;

        // Load config data
        Promise.all([
            api.getDepartments(),
            api.getEmployeeGroups(),
            api.getEmployeeGrades(),
            api.getSites()
        ]).then(([depts, grps, grads, sites]) => {
            setConfigDepartments(depts)
            setConfigGroups(grps)
            setConfigGrades(grads)
            setConfigSites(sites)
        }).catch(e => {
            console.error('Config load error:', e);
            toast.error('Failed to load configuration data: ' + e.message);
        })

        // Set email domains from active entity
        if (activeEntity?.email_domains) {
            const domains = activeEntity.email_domains.split(',').map(d => ({ domain: d.trim(), id: d.trim() }));
            setEmailDomains(domains);
        } else {
            // Default domains
            setEmailDomains([
                { domain: 'gmail.com', id: 'gmail' },
                { domain: 'hypex.com.sg', id: 'hypex' },
                { domain: 'yahoo.com', id: 'yahoo' },
                { domain: 'hotmail.com', id: 'hotmail' },
                { domain: 'outlook.com', id: 'outlook' }
            ]);
        }

        // Load employee data if editing
        if (isEditing) {
            api.getEmployee(id).then(emp => {
                let parsedAllowances = [], parsedDeductions = [];
                try {
                    if (emp.custom_allowances) {
                        const obj = JSON.parse(emp.custom_allowances);
                        parsedAllowances = Object.keys(obj).map(k => ({ key: k, value: obj[k] }));
                    }
                    if (emp.custom_deductions) {
                        const obj = JSON.parse(emp.custom_deductions);
                        parsedDeductions = Object.keys(obj).map(k => ({ key: k, value: obj[k] }));
                    }
                } catch (e) { }
                setForm({ ...emp, _parsedCustomAllowances: parsedAllowances, _parsedCustomDeductions: parsedDeductions })

                if (emp.photo_url) {
                    setPhotoPreview(emp.photo_url)
                }
            }).catch(e => {
                toast.error('Failed to load employee: ' + e.message)
                navigate('/employees')
            }).finally(() => {
                setLoading(false)
            })
        }
    }, [id, isEditing, navigate])

    const handlePhotoChange = (e) => {
        const file = e.target.files[0]
        if (file) {
            setPhotoFile(file)
            setPhotoPreview(URL.createObjectURL(file))
        }
    }

    const handleSubmit = async (e) => {
        e.preventDefault()
        setSubmitting(true)
        try {
            const formData = new FormData();

            // Core identification fields
            formData.append('employee_id', form.employee_id || '');
            formData.append('full_name', form.full_name || '');

            // Basic & Personal
            formData.append('date_of_birth', form.date_of_birth || '');
            formData.append('national_id', form.national_id || '');
            formData.append('nationality', form.nationality || 'Singapore Citizen');
            formData.append('tax_residency', form.tax_residency || 'Resident');
            formData.append('race', form.race || 'Chinese');
            formData.append('gender', form.gender || 'Male');
            formData.append('language', form.language || 'English');
            formData.append('status', form.status || 'Active');

            // Contact
            formData.append('mobile_number', form.mobile_number || '');
            formData.append('whatsapp_number', form.whatsapp_number || '');
            formData.append('email', form.email || '');

            // Employment
            formData.append('highest_education', form.highest_education || '');
            formData.append('designation', form.designation || '');
            formData.append('department', form.department || '');
            formData.append('employee_group', form.employee_group || 'General');
            formData.append('employee_grade', form.employee_grade || '');
            formData.append('site_id', form.site_id || '');
            formData.append('date_joined', form.date_joined || '');
            formData.append('cessation_date', form.cessation_date || '');
            formData.append('working_days_per_week', form.working_days_per_week || 5.5);
            formData.append('rest_day', form.rest_day || 'Sunday');
            formData.append('working_hours_per_day', form.working_hours_per_day || 8);
            formData.append('working_hours_per_week', form.working_hours_per_week || 44);

            // Payroll
            formData.append('basic_salary', form.basic_salary || 0);
            formData.append('transport_allowance', form.transport_allowance || 0);
            formData.append('meal_allowance', form.meal_allowance || 0);
            formData.append('other_allowance', form.other_allowance || 0); // Accommodation Deduction
            formData.append('other_deduction', form.other_deduction || 0); // Other Deduction
            formData.append('payment_mode', form.payment_mode || 'Bank Transfer');
            formData.append('bank_name', form.bank_name || '');
            formData.append('bank_account', form.bank_account || '');
            formData.append('cpf_applicable', form.cpf_applicable);
            formData.append('pr_status_start_date', form.pr_status_start_date || '');
            formData.append('cpf_full_rate_agreed', form.cpf_full_rate_agreed);

            // Custom Mods
            const cAllowances = {};
            form._parsedCustomAllowances?.forEach(item => { if (item.key) cAllowances[item.key] = Number(item.value) || 0; });
            const cDeductions = {};
            form._parsedCustomDeductions?.forEach(item => { if (item.key) cDeductions[item.key] = Number(item.value) || 0; });
            formData.append('custom_allowances', JSON.stringify(cAllowances));
            formData.append('custom_deductions', JSON.stringify(cDeductions));

            // Photo
            if (photoFile) {
                formData.append('photo', photoFile);
            } else if (form.photo_url) {
                formData.append('photo_url', form.photo_url);
            }

            let savedEmployee = null;
            if (isEditing) {
                savedEmployee = await api.updateEmployee(id, formData)
                toast.success('Employee updated')
            } else {
                savedEmployee = await api.createEmployee(formData)
                toast.success('Employee added')
            }

            if (savedEmployee.warning) {
                toast((t) => (
                    <span><b>Warning:</b> {savedEmployee.warning}</span>
                ), { icon: '', duration: 6000 });
            }

            // Upload any attached documents sequentially
            if (documents.length > 0) {
                const uploadPromises = documents.map(async (doc) => {
                    const docFormData = new FormData();
                    docFormData.append('employee_id', savedEmployee.id);
                    docFormData.append('document_type', doc.document_type);
                    docFormData.append('document_number', doc.document_number);
                    if (doc.issue_date) docFormData.append('issue_date', doc.issue_date);
                    if (doc.expiry_date) docFormData.append('expiry_date', doc.expiry_date);
                    if (doc.file) docFormData.append('file', doc.file);
                    return api.createDocument(docFormData);
                });
                await Promise.all(uploadPromises);
                toast.success(`Uploaded ${documents.length} documents successfully`);
            }

            navigate('/employees')
        } catch (err) {
            toast.error(err.message)
            setSubmitting(false)
        }
    }

    if (loading) {
        return (
            <div className="space-y-6">
                <div className="flex items-center gap-4">
                    <button onClick={() => navigate('/employees')} className="text-[var(--text-muted)] hover:text-[var(--text-main)] mb-1"> Back</button>
                    <div>
                        <h1 className="text-3xl font-bold text-[var(--text-main)]">Loading Employee...</h1>
                    </div>
                </div>
                <div className="card-base p-6 min-h-[400px] flex items-center justify-center">
                    <div className="w-8 h-8 border-4 border-[var(--brand-primary)]/30 border-t-cyan-500 rounded-full animate-spin"></div>
                </div>
            </div>
        )
    }

    return (
        <div className="space-y-6 max-w-5xl mx-auto">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div className="flex items-center gap-4">
                    <button onClick={() => navigate('/employees')} className="p-2 -ml-2 rounded-xl hover:bg-[var(--bg-input)] text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" title="Back to Employees">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <div>
                        <h1 className="text-3xl font-bold text-[var(--text-main)]">{isEditing ? 'Edit Employee' : 'Add New Employee'}</h1>
                        <p className="text-[var(--text-muted)] mt-1">{isEditing ? `Updating ${form.full_name}'s profile` : 'Create a new employee profile'}</p>
                    </div>
                </div>
            </div>

            <div className="card-base p-6 md:p-8">
                <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    {/* Photo Upload Header Section */}
                    <div className="md:col-span-2 lg:col-span-3 flex flex-col items-center mb-8 pb-8 border-b border-[var(--border-main)] relative">
                        <div
                            className="group relative w-40 h-40 rounded-full border-4 border-[var(--border-main)] overflow-hidden bg-[var(--bg-input)] cursor-pointer shadow-2xl transition-all hover:border-[var(--brand-primary)]"
                            onClick={() => fileInputRef.current?.click()}
                        >
                            {photoPreview ? (
                                <img src={photoPreview} alt="Preview" className="w-full h-full object-cover" />
                            ) : (
                                <div className="w-full h-full flex flex-col items-center justify-center text-[var(--text-muted)]">
                                    <span className="text-4xl mb-2"></span>
                                    <span className="text-xs font-bold uppercase tracking-wider">Upload Photo</span>
                                </div>
                            )}
                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span className="text-white text-sm font-bold uppercase">{photoPreview ? 'Change Photo' : 'Upload'}</span>
                            </div>
                        </div>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={handlePhotoChange}
                        />
                        <div className="mt-4 text-center">
                            <h3 className="text-lg font-bold text-[var(--text-main)]">{form.full_name || 'New Employee'}</h3>
                            <p className="text-xs text-[var(--text-muted)] font-bold tracking-[0.2em] uppercase mt-1">Professional Identity Photo</p>
                        </div>
                    </div>

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Basic Information</h3>
                    </div>

                    <Field form={form} setForm={setForm} label="Employee ID" name="employee_id" required />
                    <Field form={form} setForm={setForm} label="Full Name" name="full_name" required />
                    <Field form={form} setForm={setForm} label="Status" name="status" options={['Active', 'Inactive']} required />

                    <DatePicker label="Date of Birth" selected={form.date_of_birth} onChange={val => setForm({ ...form, date_of_birth: val })} required />
                    <Field form={form} setForm={setForm} label="Gender" name="gender" options={['Male', 'Female']} required />
                    <Field form={form} setForm={setForm} label="Race" name="race" options={['Chinese', 'Indian', 'Malay', 'Eurasian', 'Other']} required />

                    <Field form={form} setForm={setForm} label="Nationality" name="nationality" options={['Singapore Citizen', 'SPR', 'Foreigner']} required />
                    <Field form={form} setForm={setForm} label="National ID (NRIC/FIN)" name="national_id" required={['Singapore Citizen', 'SPR'].includes(form.nationality)} />
                    <Field form={form} setForm={setForm} label="Language" name="language" options={['English', 'Mandarin', 'Malay', 'Tamil', 'Bengali', 'Telugu', 'Hindi', 'Others']} required />

                    <Field form={form} setForm={setForm} label="Highest Education Attained" name="highest_education" options={['Primary', 'Secondary', 'O Level', 'A Level', 'Diploma', 'Bachelor Degree', 'Master Degree', 'Doctorate', 'Others']} required />

                    {form.nationality === 'SPR' && (
                        <>
                            <DatePicker label="PR Status Start Date" selected={form.pr_status_start_date} onChange={val => setForm({ ...form, pr_status_start_date: val })} required />
                            <div className="flex items-end mb-2">
                                <div className="flex items-center gap-3 w-full p-4 rounded-xl bg-cyan-950/20 border border-cyan-500/30">
                                    <input
                                        type="checkbox"
                                        checked={form.cpf_full_rate_agreed === 1}
                                        onChange={e => setForm({ ...form, cpf_full_rate_agreed: e.target.checked ? 1 : 0 })}
                                        className="w-5 h-5 rounded accent-cyan-500"
                                    />
                                    <label className="text-sm font-medium text-cyan-200 cursor-pointer" onClick={() => setForm({ ...form, cpf_full_rate_agreed: form.cpf_full_rate_agreed === 1 ? 0 : 1 })}>
                                        Full CPF Rate Agreed (Employer & Employee)
                                    </label>
                                </div>
                            </div>
                        </>
                    )}

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mt-4 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Contact Information</h3>
                    </div>

                    <Field form={form} setForm={setForm} label="Mobile Number" name="mobile_number" type="tel" />

                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">WhatsApp Number</label>
                        <div className="flex gap-2">
                            <input
                                type="tel"
                                value={form.whatsapp_number || ''}
                                onChange={e => setForm({ ...form, whatsapp_number: e.target.value })}
                                className="input-base flex-1"
                            />
                            <button
                                type="button"
                                onClick={() => setForm({ ...form, whatsapp_number: form.mobile_number })}
                                className="px-3 py-2 rounded-xl bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 border border-emerald-500/20 transition-colors text-sm whitespace-nowrap flex items-center gap-1.5"
                                title="Copy from Mobile"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Same as Mobile
                            </button>
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">Email Address</label>
                        <input
                            type="email"
                            list="email-domains"
                            className="input-base w-full"
                            value={form.email || ''}
                            onChange={e => setForm({ ...form, email: e.target.value })}
                            placeholder="employee@domain.com"
                        />
                        <datalist id="email-domains">
                            {form.email && !form.email.includes('@') && emailDomains.map(d => (
                                <option key={d.id} value={`${form.email}@${d.domain}`} />
                            ))}
                        </datalist>
                    </div>

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mt-4 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Employment Details</h3>
                    </div>

                    <DatePicker label="Date Joined" selected={form.date_joined} onChange={val => setForm({ ...form, date_joined: val })} required />
                    <DatePicker label="Cessation Date" selected={form.cessation_date} onChange={val => setForm({ ...form, cessation_date: val })} />
                    <Field form={form} setForm={setForm} label="Working Days Per Week" name="working_days_per_week" options={['3', '3.5', '4', '4.5', '5', '5.25 (Alternate Saturday Off)', '5.5', '6']} />
                    <Field form={form} setForm={setForm} label="Rest Day" name="rest_day" options={['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']} />
                    <Field form={form} setForm={setForm} label="Work Hours Per Day" name="working_hours_per_day" type="number" step="0.5" />
                    <Field form={form} setForm={setForm} label="Normal Work Hours Per Week" name="working_hours_per_week" type="number" step="0.5" />

                    {/* Dynamic Departments Dropdown */}
                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">
                            Department <span className="text-rose-500">*</span>
                        </label>
                        <select value={form.department || ''} onChange={e => setForm({ ...form, department: e.target.value })} className="select-base" required>
                            <option value="">Select a Department...</option>
                            {configDepartments.map(d => (
                                <option key={d.id} value={d.name}>{d.name}</option>
                            ))}
                        </select>
                    </div>

                    <Field form={form} setForm={setForm} label="Designation" name="designation" required />

                    {/* Dynamic Groups Dropdown */}
                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">
                            Employee Group <span className="text-rose-500">*</span>
                        </label>
                        <select value={form.employee_group || 'General'} onChange={e => setForm({ ...form, employee_group: e.target.value })} className="select-base" required>
                            {configGroups.map(g => (
                                <option key={g.id} value={g.name}>{g.name}</option>
                            ))}
                        </select>
                    </div>

                    {/* Dynamic Grades Dropdown */}
                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">Employee Grade</label>
                        <select value={form.employee_grade || ''} onChange={e => setForm({ ...form, employee_grade: e.target.value })} className="select-base">
                            <option value="">No Grade</option>
                            {configGrades.map(g => (
                                <option key={g.id} value={g.name}>{g.name}</option>
                            ))}
                        </select>
                    </div>

                    {/* Dynamic Sites Dropdown */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">Site Assignment</label>
                        <select value={form.site_id || ''} onChange={e => setForm({ ...form, site_id: e.target.value ? parseInt(e.target.value) : '' })} className="select-base border-amber-500/30 focus:border-amber-500">
                            <option value="">Headquarters / No Fixed Site</option>
                            {configSites.map(s => (
                                <option key={s.id} value={s.id}>{s.name} ({s.customer_name})</option>
                            ))}
                        </select>
                    </div>

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mt-4 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Payroll & Compensation</h3>
                    </div>

                    <Field form={form} setForm={setForm} label="Basic Salary (S$)" name="basic_salary" type="number" required />
                    <Field form={form} setForm={setForm} label="Payment Mode" name="payment_mode" options={['Bank Transfer', 'GIRO', 'Cash', 'Cheque']} required />
                    <Field form={form} setForm={setForm} label="Tax Residency" name="tax_residency" options={['Resident', 'Non-Resident']} required />

                    <Field form={form} setForm={setForm} label="Bank Name" name="bank_name" />
                    <Field form={form} setForm={setForm} label="Bank Account" name="bank_account" />

                    <div className="md:col-span-1">
                        <div className="h-full flex items-center gap-3 p-3.5 rounded-xl bg-[var(--bg-input)] border border-[var(--border-main)] transition-all">
                            <input type="checkbox" checked={form.cpf_applicable === 1} onChange={e => setForm({ ...form, cpf_applicable: e.target.checked ? 1 : 0 })} className="w-5 h-5 rounded accent-[var(--brand-primary)]" />
                            <label className="text-sm font-medium text-[var(--text-muted)] cursor-pointer leading-tight select-none" onClick={() => setForm({ ...form, cpf_applicable: form.cpf_applicable === 1 ? 0 : 1 })}>
                                CPF Applicable <br />
                                <span className="text-[10px] opacity-70">(Citizens & SPR)</span>
                            </label>
                        </div>
                    </div>

                    {/* MOM Rate Displays */}
                    <div className="md:col-span-2 lg:col-span-2 grid grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-blue-500/5 rounded-xl border border-blue-500/20 shadow-sm backdrop-blur-sm">
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">Daily Basic Rate</p>
                            <p className="text-lg font-semibold text-[var(--info)]">
                                ${((12 * (form.basic_salary || 0)) / (52 * (parseFloat(form.working_days_per_week) || 5.5))).toFixed(2)}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">Hourly Basic Rate</p>
                            <p className="text-lg font-semibold text-[var(--info)]">
                                ${((12 * (form.basic_salary || 0)) / (52 * (form.working_hours_per_week || 44))).toFixed(2)}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">1.5x OT Rate</p>
                            <p className="text-lg font-semibold text-[var(--success)]">
                                ${(((12 * (form.basic_salary || 0)) / (52 * (form.working_hours_per_week || 44))) * 1.5).toFixed(2)}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">2.0x OT Rate</p>
                            <p className="text-lg font-semibold text-[var(--warning)]">
                                ${(((12 * (form.basic_salary || 0)) / (52 * (form.working_hours_per_week || 44))) * 2.0).toFixed(2)}
                            </p>
                        </div>
                    </div>

                    <Field form={form} setForm={setForm} label="Fixed Transport Allowance ($)" name="transport_allowance" type="number" />
                    <Field form={form} setForm={setForm} label="Fixed Allowance" name="meal_allowance" type="number" />
                    <Field form={form} setForm={setForm} label="Accommodation Deduction" name="other_allowance" type="number" />
                    <Field form={form} setForm={setForm} label="Other Deduction" name="other_deduction" type="number" />

                    <div className="md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div className="space-y-4">
                            <h4 className="text-md font-medium text-emerald-400">Custom Allowances</h4>
                            <div className="space-y-3 dark-scrollbar max-h-48 overflow-y-auto pr-2">
                                {form._parsedCustomAllowances.map((item, index) => (
                                    <div key={index} className="flex gap-2 items-center">
                                        <input type="text" placeholder="Name (e.g. Handphone)" value={item.key} onChange={e => {
                                            const newArr = [...form._parsedCustomAllowances];
                                            newArr[index].key = e.target.value;
                                            setForm({ ...form, _parsedCustomAllowances: newArr });
                                        }} className="input-base flex-1" />
                                        <input type="number" placeholder="Amount" value={item.value} onChange={e => {
                                            const newArr = [...form._parsedCustomAllowances];
                                            newArr[index].value = e.target.value;
                                            setForm({ ...form, _parsedCustomAllowances: newArr });
                                        }} className="input-base w-24 sm:w-32" />
                                        <button type="button" onClick={() => {
                                            const newArr = form._parsedCustomAllowances.filter((_, i) => i !== index);
                                            setForm({ ...form, _parsedCustomAllowances: newArr });
                                        }} className="w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors"></button>
                                    </div>
                                ))}
                                <button type="button" onClick={() => setForm({ ...form, _parsedCustomAllowances: [...form._parsedCustomAllowances, { key: '', value: 0 }] })} className="w-full text-sm py-2 rounded-lg border border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/10 transition-colors">+ Add Allowance</button>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <h4 className="text-md font-medium text-orange-400">Custom Deductions</h4>
                            <div className="space-y-3 dark-scrollbar max-h-48 overflow-y-auto pr-2">
                                {form._parsedCustomDeductions.map((item, index) => (
                                    <div key={index} className="flex gap-2 items-center">
                                        <input type="text" placeholder="Name (e.g. Loan Repayment)" value={item.key} onChange={e => {
                                            const newArr = [...form._parsedCustomDeductions];
                                            newArr[index].key = e.target.value;
                                            setForm({ ...form, _parsedCustomDeductions: newArr });
                                        }} className="input-base flex-1" />
                                        <input type="number" placeholder="Amount" value={item.value} onChange={e => {
                                            const newArr = [...form._parsedCustomDeductions];
                                            newArr[index].value = e.target.value;
                                            setForm({ ...form, _parsedCustomDeductions: newArr });
                                        }} className="input-base w-24 sm:w-32" />
                                        <button type="button" onClick={() => {
                                            const newArr = form._parsedCustomDeductions.filter((_, i) => i !== index);
                                            setForm({ ...form, _parsedCustomDeductions: newArr });
                                        }} className="w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors"></button>
                                    </div>
                                ))}
                                <button type="button" onClick={() => setForm({ ...form, _parsedCustomDeductions: [...form._parsedCustomDeductions, { key: '', value: 0 }] })} className="w-full text-sm py-2 rounded-lg border border-orange-500/30 text-orange-400 hover:bg-orange-500/10 transition-colors">+ Add Deduction</button>
                            </div>
                        </div>
                    </div>

                    {/* Document Uploads only applicable for New Employees because existing employees have a dedicated tab for document management. */}
                    {!isEditing && (
                        <div className="md:col-span-2 lg:col-span-3 pt-6 border-t border-[var(--border-main)] mt-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Initial ID Documents & Passes</h3>
                                <button
                                    type="button"
                                    onClick={() => setDocuments([...documents, { document_type: 'NRIC', document_number: '', issue_date: '', expiry_date: '', file: null }])}
                                    className="text-sm px-4 py-1.5 rounded-lg bg-[var(--brand-primary)]/10 text-[var(--brand-primary)] hover:bg-[var(--brand-primary)]/20 border border-[var(--brand-primary)]/30 transition-colors"
                                >
                                    + Attach Document
                                </button>
                            </div>

                            <div className="space-y-3">
                                {documents.map((doc, index) => (
                                    <div key={index} className="flex flex-wrap items-center gap-3 p-4 rounded-xl bg-slate-800/30 border border-[var(--border-main)] relative group">
                                        <button
                                            type="button"
                                            onClick={() => setDocuments(documents.filter((_, i) => i !== index))}
                                            className="absolute -top-3 -right-3 w-7 h-7 rounded-full bg-slate-800 border border-red-500/50 text-red-400 flex items-center justify-center text-sm shadow-lg hover:bg-red-500/20 transition-colors opacity-0 xl:opacity-100 group-hover:opacity-100"
                                        >
                                            
                                        </button>

                                        <select
                                            value={doc.document_type}
                                            onChange={e => {
                                                const newDocs = [...documents];
                                                newDocs[index].document_type = e.target.value;
                                                setDocuments(newDocs);
                                            }}
                                            className="select-base w-32"
                                        >
                                            <option>NRIC</option>
                                            <option>FIN</option>
                                            <option>Passport</option>
                                            <option>Work Pass</option>
                                            <option>Skill Pass</option>
                                        </select>

                                        <input
                                            type="text"
                                            placeholder="Doc Number"
                                            required
                                            value={doc.document_number}
                                            onChange={e => {
                                                const newDocs = [...documents];
                                                newDocs[index].document_number = e.target.value;
                                                setDocuments(newDocs);
                                            }}
                                            className="input-base flex-1 min-w-[150px]"
                                        />

                                        <DatePicker
                                            selected={doc.issue_date}
                                            onChange={val => {
                                                const newDocs = [...documents];
                                                newDocs[index].issue_date = val;
                                                setDocuments(newDocs);
                                            }}
                                            placeholderText="Issue Date"
                                        />

                                        <DatePicker
                                            selected={doc.expiry_date}
                                            onChange={val => {
                                                const newDocs = [...documents];
                                                newDocs[index].expiry_date = val;
                                                setDocuments(newDocs);
                                            }}
                                            placeholderText="Expiry Date"
                                        />

                                        <div className="w-full xl:w-auto mt-2 xl:mt-0">
                                            <input
                                                type="file"
                                                onChange={e => {
                                                    const newDocs = [...documents];
                                                    newDocs[index].file = e.target.files[0];
                                                    setDocuments(newDocs);
                                                }}
                                                className="w-full text-sm text-[var(--text-muted)] file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border file:border-[var(--brand-primary)]/30 file:text-sm file:font-medium file:bg-[var(--brand-primary)]/10 file:text-[var(--brand-primary)] hover:file:bg-cyan-500/20 file:cursor-pointer"
                                            />
                                        </div>
                                    </div>
                                ))}
                                {documents.length === 0 && (
                                    <div className="text-center py-6 border border-dashed border-[var(--border-main)] rounded-xl bg-white/[0.02]">
                                        <p className="text-[var(--text-muted)] text-sm">No initial documents attached.</p>
                                        <p className="text-[var(--text-muted)] text-xs mt-1">You can attach NRICs, passports, or valid passes here, or upload them later on the employee's Documents tab.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="md:col-span-2 lg:col-span-3 pt-6 mt-4 border-t border-[var(--border-main)] flex items-center justify-end gap-4">
                        <button type="button" onClick={() => navigate('/employees')} className="px-6 py-3 rounded-xl border border-[var(--border-main)] text-[var(--text-muted)] hover:bg-[var(--bg-input)] transition-all font-medium">
                            Cancel
                        </button>
                        <button type="submit" disabled={submitting} className="btn-primary px-8 py-3 text-base flex items-center gap-2">
                            {submitting ? (
                                <>
                                    <div className="w-4 h-4 border-2 border-[var(--border-main)] border-t-white rounded-full animate-spin"></div>
                                    Saving...
                                </>
                            ) : (
                                isEditing ? 'Save Changes' : 'Create Employee Profile'
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    )
}
===
import { useState, useEffect, useRef } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { useAuth } from '../context/AuthContext'
import toast from 'react-hot-toast'
import api from '../services/api'
import DatePicker from '../components/DatePicker'

const emptyEmployee = {
    employee_id: '', full_name: '', date_of_birth: '', national_id: '', nationality: 'Singapore Citizen',
    tax_residency: 'Resident', race: 'Chinese', gender: 'Male', language: 'English', mobile_number: '', whatsapp_number: '', email: '', highest_education: '', designation: '', department: '', employee_group: 'General', employee_grade: '', site_id: '',
    date_joined: '', cessation_date: '', basic_salary: 0, transport_allowance: 0, meal_allowance: 0,
    other_allowance: 0, payment_mode: 'Bank Transfer', custom_allowances: '{}', custom_deductions: '{}',
    bank_name: '', bank_account: '', cpf_applicable: 0,
    pr_status_start_date: '', cpf_full_rate_agreed: 0,
    working_days_per_week: 5.5, rest_day: 'Sunday',
    working_hours_per_day: 8, working_hours_per_week: 44,
    status: 'Active', photo_url: null,
    other_deduction: 0,
    work_pass_type: '', work_pass_expiry: '',
    _parsedCustomAllowances: [], _parsedCustomDeductions: []
}

const Field = ({ label, name, type = 'text', options, required, span2, form, setForm, min, max }) => (
    <div className={span2 ? 'md:col-span-2' : ''}>
        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">
            {label} {required && <span className="text-rose-500">*</span>}
        </label>
        {options ? (
            <select value={form[name]} onChange={e => setForm({ ...form, [name]: e.target.value })} className="select-base" required={required}>
                {options.map(o => <option key={o} value={o}>{o}</option>)}
            </select>
        ) : (
            <input
                type={type}
                value={form[name] || ''}
                onChange={e => setForm({ ...form, [name]: type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value })}
                className="input-base"
                required={required}
                step={type === 'number' ? '0.01' : undefined}
            />
        )}
    </div>
)

export default function EmployeeForm() {
    const { id } = useParams()
    const navigate = useNavigate()
    const { activeEntity } = useAuth()
    const isEditing = Boolean(id)
    const fileInputRef = useRef(null)

    const [loading, setLoading] = useState(isEditing)
    const [submitting, setSubmitting] = useState(false)
    const [form, setForm] = useState(emptyEmployee)
    const [documents, setDocuments] = useState([])
    const [photoFile, setPhotoFile] = useState(null)
    const [photoPreview, setPhotoPreview] = useState(null)

    // Config data
    const [configDepartments, setConfigDepartments] = useState([])
    const [configGroups, setConfigGroups] = useState([])
    const [configGrades, setConfigGrades] = useState([])
    const [configSites, setConfigSites] = useState([])

    const [emailDomains, setEmailDomains] = useState([])

    useEffect(() => {
        if (!activeEntity) return;

        // Load config data
        Promise.all([
            api.getDepartments(),
            api.getEmployeeGroups(),
            api.getEmployeeGrades(),
            api.getSites()
        ]).then(([depts, grps, grads, sites]) => {
            setConfigDepartments(depts)
            setConfigGroups(grps)
            setConfigGrades(grads)
            setConfigSites(sites)
        }).catch(e => {
            console.error('Config load error:', e);
            toast.error('Failed to load configuration data: ' + e.message);
        })

        // Set email domains from active entity
        if (activeEntity?.email_domains) {
            const domains = activeEntity.email_domains.split(',').map(d => ({ domain: d.trim(), id: d.trim() }));
            setEmailDomains(domains);
        } else {
            // Default domains
            setEmailDomains([
                { domain: 'gmail.com', id: 'gmail' },
                { domain: 'hypex.com.sg', id: 'hypex' },
                { domain: 'yahoo.com', id: 'yahoo' },
                { domain: 'hotmail.com', id: 'hotmail' },
                { domain: 'outlook.com', id: 'outlook' }
            ]);
        }

        // Load employee data if editing
        if (isEditing) {
            api.getEmployee(id).then(emp => {
                let parsedAllowances = [], parsedDeductions = [];
                try {
                    if (emp.custom_allowances) {
                        const obj = JSON.parse(emp.custom_allowances);
                        parsedAllowances = Object.keys(obj).map(k => ({ key: k, value: obj[k] }));
                    }
                    if (emp.custom_deductions) {
                        const obj = JSON.parse(emp.custom_deductions);
                        parsedDeductions = Object.keys(obj).map(k => ({ key: k, value: obj[k] }));
                    }
                } catch (e) { }
                setForm({ ...emp, _parsedCustomAllowances: parsedAllowances, _parsedCustomDeductions: parsedDeductions })

                if (emp.photo_url) {
                    setPhotoPreview(emp.photo_url)
                }
            }).catch(e => {
                toast.error('Failed to load employee: ' + e.message)
                navigate('/employees')
            }).finally(() => {
                setLoading(false)
            })
        }
    }, [id, isEditing, navigate])

    const handlePhotoChange = (e) => {
        const file = e.target.files[0]
        if (file) {
            setPhotoFile(file)
            setPhotoPreview(URL.createObjectURL(file))
        }
    }

    const handleSubmit = async (e) => {
        e.preventDefault()
        setSubmitting(true)
        try {
            const formData = new FormData();

            // Core identification fields
            formData.append('employee_id', form.employee_id || '');
            formData.append('full_name', form.full_name || '');

            // Basic & Personal
            formData.append('date_of_birth', form.date_of_birth || '');
            formData.append('national_id', form.national_id || '');
            formData.append('nationality', form.nationality || 'Singapore Citizen');
            formData.append('tax_residency', form.tax_residency || 'Resident');
            formData.append('race', form.race || 'Chinese');
            formData.append('gender', form.gender || 'Male');
            formData.append('language', form.language || 'English');
            formData.append('status', form.status || 'Active');
            formData.append('work_pass_type', form.work_pass_type || '');
            formData.append('work_pass_expiry', form.work_pass_expiry || '');

            // Contact
            formData.append('mobile_number', form.mobile_number || '');
            formData.append('whatsapp_number', form.whatsapp_number || '');
            formData.append('email', form.email || '');

            // Employment
            formData.append('highest_education', form.highest_education || '');
            formData.append('designation', form.designation || '');
            formData.append('department', form.department || '');
            formData.append('employee_group', form.employee_group || 'General');
            formData.append('employee_grade', form.employee_grade || '');
            formData.append('site_id', form.site_id || '');
            formData.append('date_joined', form.date_joined || '');
            formData.append('cessation_date', form.cessation_date || '');
            formData.append('working_days_per_week', form.working_days_per_week || 5.5);
            formData.append('rest_day', form.rest_day || 'Sunday');
            formData.append('working_hours_per_day', form.working_hours_per_day || 8);
            formData.append('working_hours_per_week', form.working_hours_per_week || 44);

            // Payroll
            formData.append('basic_salary', form.basic_salary || 0);
            formData.append('transport_allowance', form.transport_allowance || 0);
            formData.append('meal_allowance', form.meal_allowance || 0);
            formData.append('other_allowance', form.other_allowance || 0); // Accommodation Deduction
            formData.append('other_deduction', form.other_deduction || 0); // Other Deduction
            formData.append('payment_mode', form.payment_mode || 'Bank Transfer');
            formData.append('bank_name', form.bank_name || '');
            formData.append('bank_account', form.bank_account || '');
            formData.append('cpf_applicable', form.cpf_applicable);
            formData.append('pr_status_start_date', form.pr_status_start_date || '');
            formData.append('cpf_full_rate_agreed', form.cpf_full_rate_agreed);

            // Custom Mods
            const cAllowances = {};
            form._parsedCustomAllowances?.forEach(item => { if (item.key) cAllowances[item.key] = Number(item.value) || 0; });
            const cDeductions = {};
            form._parsedCustomDeductions?.forEach(item => { if (item.key) cDeductions[item.key] = Number(item.value) || 0; });
            formData.append('custom_allowances', JSON.stringify(cAllowances));
            formData.append('custom_deductions', JSON.stringify(cDeductions));

            // Photo
            if (photoFile) {
                formData.append('photo', photoFile);
            } else if (form.photo_url) {
                formData.append('photo_url', form.photo_url);
            }

            let savedEmployee = null;
            if (isEditing) {
                savedEmployee = await api.updateEmployee(id, formData)
                toast.success('Employee updated')
            } else {
                savedEmployee = await api.createEmployee(formData)
                toast.success('Employee added')
            }

            if (savedEmployee.warning) {
                toast((t) => (
                    <span><b>Warning:</b> {savedEmployee.warning}</span>
                ), { icon: '', duration: 6000 });
            }

            // Upload any attached documents sequentially
            if (documents.length > 0) {
                const uploadPromises = documents.map(async (doc) => {
                    const docFormData = new FormData();
                    docFormData.append('employee_id', savedEmployee.id);
                    docFormData.append('document_type', doc.document_type);
                    docFormData.append('document_number', doc.document_number);
                    if (doc.issue_date) docFormData.append('issue_date', doc.issue_date);
                    if (doc.expiry_date) docFormData.append('expiry_date', doc.expiry_date);
                    if (doc.file) docFormData.append('file', doc.file);
                    return api.createDocument(docFormData);
                });
                await Promise.all(uploadPromises);
                toast.success(`Uploaded ${documents.length} documents successfully`);
            }

            navigate('/employees')
        } catch (err) {
            toast.error(err.message)
            setSubmitting(false)
        }
    }

    if (loading) {
        return (
            <div className="space-y-6">
                <div className="flex items-center gap-4">
                    <button onClick={() => navigate('/employees')} className="text-[var(--text-muted)] hover:text-[var(--text-main)] mb-1"> Back</button>
                    <div>
                        <h1 className="text-3xl font-bold text-[var(--text-main)]">Loading Employee...</h1>
                    </div>
                </div>
                <div className="card-base p-6 min-h-[400px] flex items-center justify-center">
                    <div className="w-8 h-8 border-4 border-[var(--brand-primary)]/30 border-t-cyan-500 rounded-full animate-spin"></div>
                </div>
            </div>
        )
    }

    return (
        <div className="space-y-6 max-w-5xl mx-auto">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div className="flex items-center gap-4">
                    <button onClick={() => navigate('/employees')} className="p-2 -ml-2 rounded-xl hover:bg-[var(--bg-input)] text-[var(--text-muted)] hover:text-[var(--text-main)] transition-colors" title="Back to Employees">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <div>
                        <h1 className="text-3xl font-bold text-[var(--text-main)]">{isEditing ? 'Edit Employee' : 'Add New Employee'}</h1>
                        <p className="text-[var(--text-muted)] mt-1">{isEditing ? `Updating ${form.full_name}'s profile` : 'Create a new employee profile'}</p>
                    </div>
                </div>
            </div>

            <div className="card-base p-6 md:p-8">
                <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    {/* Photo Upload Header Section */}
                    <div className="md:col-span-2 lg:col-span-3 flex flex-col items-center mb-8 pb-8 border-b border-[var(--border-main)] relative">
                        <div
                            className="group relative w-40 h-40 rounded-full border-4 border-[var(--border-main)] overflow-hidden bg-[var(--bg-input)] cursor-pointer shadow-2xl transition-all hover:border-[var(--brand-primary)]"
                            onClick={() => fileInputRef.current?.click()}
                        >
                            {photoPreview ? (
                                <img src={photoPreview} alt="Preview" className="w-full h-full object-cover" />
                            ) : (
                                <div className="w-full h-full flex flex-col items-center justify-center text-[var(--text-muted)]">
                                    <span className="text-4xl mb-2"></span>
                                    <span className="text-xs font-bold uppercase tracking-wider">Upload Photo</span>
                                </div>
                            )}
                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span className="text-white text-sm font-bold uppercase">{photoPreview ? 'Change Photo' : 'Upload'}</span>
                            </div>
                        </div>
                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={handlePhotoChange}
                        />
                        <div className="mt-4 text-center">
                            <h3 className="text-lg font-bold text-[var(--text-main)]">{form.full_name || 'New Employee'}</h3>
                            <p className="text-xs text-[var(--text-muted)] font-bold tracking-[0.2em] uppercase mt-1">Professional Identity Photo</p>
                        </div>
                    </div>

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Basic Information</h3>
                    </div>

                    <Field form={form} setForm={setForm} label="Employee ID" name="employee_id" required />
                    <Field form={form} setForm={setForm} label="Full Name" name="full_name" required />
                    <Field form={form} setForm={setForm} label="Status" name="status" options={['Active', 'Inactive']} required />

                    <DatePicker label="Date of Birth" selected={form.date_of_birth} onChange={val => setForm({ ...form, date_of_birth: val })} required />
                    <Field form={form} setForm={setForm} label="Gender" name="gender" options={['Male', 'Female']} required />
                    <Field form={form} setForm={setForm} label="Race" name="race" options={['Chinese', 'Indian', 'Malay', 'Eurasian', 'Other']} required />

                    <Field form={form} setForm={setForm} label="Nationality" name="nationality" options={['Singapore Citizen', 'SPR', 'Foreigner']} required />
                    <Field form={form} setForm={setForm} label="National ID (NRIC/FIN)" name="national_id" required={['Singapore Citizen', 'SPR'].includes(form.nationality)} />
                    <Field form={form} setForm={setForm} label="Language" name="language" options={['English', 'Mandarin', 'Malay', 'Tamil', 'Bengali', 'Telugu', 'Hindi', 'Others']} required />

                    <Field form={form} setForm={setForm} label="Highest Education Attained" name="highest_education" options={['Primary', 'Secondary', 'O Level', 'A Level', 'Diploma', 'Bachelor Degree', 'Master Degree', 'Doctorate', 'Others']} required />
                    
                    {form.nationality === 'Foreigner' && (
                        <>
                            <Field form={form} setForm={setForm} label="Work Pass Type" name="work_pass_type" options={['Employment Pass', 'S Pass', 'Work Permit', 'Dependent Pass (with LOC)', 'Other']} required />
                            <DatePicker label="Work Pass Expiry" selected={form.work_pass_expiry} onChange={val => setForm({ ...form, work_pass_expiry: val })} required />
                        </>
                    )}

                    {form.nationality === 'SPR' && (
                        <>
                            <DatePicker label="PR Status Start Date" selected={form.pr_status_start_date} onChange={val => setForm({ ...form, pr_status_start_date: val })} required />
                            <div className="flex items-end mb-2">
                                <div className="flex items-center gap-3 w-full p-4 rounded-xl bg-cyan-950/20 border border-cyan-500/30">
                                    <input
                                        type="checkbox"
                                        checked={form.cpf_full_rate_agreed === 1}
                                        onChange={e => setForm({ ...form, cpf_full_rate_agreed: e.target.checked ? 1 : 0 })}
                                        className="w-5 h-5 rounded accent-cyan-500"
                                    />
                                    <label className="text-sm font-medium text-cyan-200 cursor-pointer" onClick={() => setForm({ ...form, cpf_full_rate_agreed: form.cpf_full_rate_agreed === 1 ? 0 : 1 })}>
                                        Full CPF Rate Agreed (Employer & Employee)
                                    </label>
                                </div>
                            </div>
                        </>
                    )}

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mt-4 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Contact Information</h3>
                    </div>

                    <Field form={form} setForm={setForm} label="Mobile Number" name="mobile_number" type="tel" />

                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">WhatsApp Number</label>
                        <div className="flex gap-2">
                            <input
                                type="tel"
                                value={form.whatsapp_number || ''}
                                onChange={e => setForm({ ...form, whatsapp_number: e.target.value })}
                                className="input-base flex-1"
                            />
                            <button
                                type="button"
                                onClick={() => setForm({ ...form, whatsapp_number: form.mobile_number })}
                                className="px-3 py-2 rounded-xl bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 border border-emerald-500/20 transition-colors text-sm whitespace-nowrap flex items-center gap-1.5"
                                title="Copy from Mobile"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Same as Mobile
                            </button>
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">Email Address</label>
                        <input
                            type="email"
                            list="email-domains"
                            className="input-base w-full"
                            value={form.email || ''}
                            onChange={e => setForm({ ...form, email: e.target.value })}
                            placeholder="employee@domain.com"
                        />
                        <datalist id="email-domains">
                            {form.email && !form.email.includes('@') && emailDomains.map(d => (
                                <option key={d.id} value={`${form.email}@${d.domain}`} />
                            ))}
                        </datalist>
                    </div>

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mt-4 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Employment Details</h3>
                    </div>

                    <DatePicker label="Date Joined" selected={form.date_joined} onChange={val => setForm({ ...form, date_joined: val })} required />
                    <DatePicker label="Cessation Date" selected={form.cessation_date} onChange={val => setForm({ ...form, cessation_date: val })} />
                    <Field form={form} setForm={setForm} label="Working Days Per Week" name="working_days_per_week" options={['3', '3.5', '4', '4.5', '5', '5.25 (Alternate Saturday Off)', '5.5', '6']} />
                    <Field form={form} setForm={setForm} label="Rest Day" name="rest_day" options={['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']} />
                    <Field form={form} setForm={setForm} label="Work Hours Per Day" name="working_hours_per_day" type="number" step="0.5" />
                    <Field form={form} setForm={setForm} label="Normal Work Hours Per Week" name="working_hours_per_week" type="number" step="0.5" />

                    {/* Dynamic Departments Dropdown */}
                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">
                            Department <span className="text-rose-500">*</span>
                        </label>
                        <select value={form.department || ''} onChange={e => setForm({ ...form, department: e.target.value })} className="select-base" required>
                            <option value="">Select a Department...</option>
                            {configDepartments.map(d => (
                                <option key={d.id} value={d.name}>{d.name}</option>
                            ))}
                        </select>
                    </div>

                    <Field form={form} setForm={setForm} label="Designation" name="designation" required />

                    {/* Dynamic Groups Dropdown */}
                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">
                            Employee Group <span className="text-rose-500">*</span>
                        </label>
                        <select value={form.employee_group || 'General'} onChange={e => setForm({ ...form, employee_group: e.target.value })} className="select-base" required>
                            {configGroups.map(g => (
                                <option key={g.id} value={g.name}>{g.name}</option>
                            ))}
                        </select>
                    </div>

                    {/* Dynamic Grades Dropdown */}
                    <div>
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">Employee Grade</label>
                        <select value={form.employee_grade || ''} onChange={e => setForm({ ...form, employee_grade: e.target.value })} className="select-base">
                            <option value="">No Grade</option>
                            {configGrades.map(g => (
                                <option key={g.id} value={g.name}>{g.name}</option>
                            ))}
                        </select>
                    </div>

                    {/* Dynamic Sites Dropdown */}
                    <div className="md:col-span-2 lg:col-span-1">
                        <label className="block text-sm font-medium text-[var(--text-muted)] mb-1.5">Site Assignment</label>
                        <select value={form.site_id || ''} onChange={e => setForm({ ...form, site_id: e.target.value ? parseInt(e.target.value) : '' })} className="select-base border-amber-500/30 focus:border-amber-500">
                            <option value="">Headquarters / No Fixed Site</option>
                            {configSites.map(s => (
                                <option key={s.id} value={s.id}>{s.name} ({s.customer_name})</option>
                            ))}
                        </select>
                    </div>

                    <div className="md:col-span-2 lg:col-span-3 border-b border-[var(--border-main)] pb-2 mt-4 mb-2">
                        <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Payroll & Compensation</h3>
                    </div>

                    <Field form={form} setForm={setForm} label="Basic Salary (S$)" name="basic_salary" type="number" required />
                    <Field form={form} setForm={setForm} label="Payment Mode" name="payment_mode" options={['Bank Transfer', 'GIRO', 'Cash', 'Cheque']} required />
                    <Field form={form} setForm={setForm} label="Tax Residency" name="tax_residency" options={['Resident', 'Non-Resident']} required />

                    <Field form={form} setForm={setForm} label="Bank Name" name="bank_name" />
                    <Field form={form} setForm={setForm} label="Bank Account" name="bank_account" />

                    <div className="md:col-span-1">
                        <div className="h-full flex items-center gap-3 p-3.5 rounded-xl bg-[var(--bg-input)] border border-[var(--border-main)] transition-all">
                            <input type="checkbox" checked={form.cpf_applicable === 1} onChange={e => setForm({ ...form, cpf_applicable: e.target.checked ? 1 : 0 })} className="w-5 h-5 rounded accent-[var(--brand-primary)]" />
                            <label className="text-sm font-medium text-[var(--text-muted)] cursor-pointer leading-tight select-none" onClick={() => setForm({ ...form, cpf_applicable: form.cpf_applicable === 1 ? 0 : 1 })}>
                                CPF Applicable <br />
                                <span className="text-[10px] opacity-70">(Citizens & SPR)</span>
                            </label>
                        </div>
                    </div>

                    {/* MOM Rate Displays */}
                    <div className="md:col-span-2 lg:col-span-2 grid grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-blue-500/5 rounded-xl border border-blue-500/20 shadow-sm backdrop-blur-sm">
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">Daily Basic Rate</p>
                            <p className="text-lg font-semibold text-[var(--info)]">
                                ${((12 * (form.basic_salary || 0)) / (52 * (parseFloat(form.working_days_per_week) || 5.5))).toFixed(2)}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">Hourly Basic Rate</p>
                            <p className="text-lg font-semibold text-[var(--info)]">
                                ${((12 * (form.basic_salary || 0)) / (52 * (form.working_hours_per_week || 44))).toFixed(2)}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">1.5x OT Rate</p>
                            <p className="text-lg font-semibold text-[var(--success)]">
                                ${(((12 * (form.basic_salary || 0)) / (52 * (form.working_hours_per_week || 44))) * 1.5).toFixed(2)}
                            </p>
                        </div>
                        <div>
                            <p className="text-xs text-[var(--text-muted)] uppercase font-bold tracking-wider mb-1">2.0x OT Rate</p>
                            <p className="text-lg font-semibold text-[var(--warning)]">
                                ${(((12 * (form.basic_salary || 0)) / (52 * (form.working_hours_per_week || 44))) * 2.0).toFixed(2)}
                            </p>
                        </div>
                    </div>

                    <Field form={form} setForm={setForm} label="Fixed Transport Allowance ($)" name="transport_allowance" type="number" />
                    <Field form={form} setForm={setForm} label="Fixed Allowance" name="meal_allowance" type="number" />
                    <Field form={form} setForm={setForm} label="Accommodation Deduction" name="other_allowance" type="number" />
                    <Field form={form} setForm={setForm} label="Other Deduction" name="other_deduction" type="number" />

                    <div className="md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div className="space-y-4">
                            <h4 className="text-md font-medium text-emerald-400">Custom Allowances</h4>
                            <div className="space-y-3 dark-scrollbar max-h-48 overflow-y-auto pr-2">
                                {form._parsedCustomAllowances.map((item, index) => (
                                    <div key={index} className="flex gap-2 items-center">
                                        <input type="text" placeholder="Name (e.g. Handphone)" value={item.key} onChange={e => {
                                            const newArr = [...form._parsedCustomAllowances];
                                            newArr[index].key = e.target.value;
                                            setForm({ ...form, _parsedCustomAllowances: newArr });
                                        }} className="input-base flex-1" />
                                        <input type="number" placeholder="Amount" value={item.value} onChange={e => {
                                            const newArr = [...form._parsedCustomAllowances];
                                            newArr[index].value = e.target.value;
                                            setForm({ ...form, _parsedCustomAllowances: newArr });
                                        }} className="input-base w-24 sm:w-32" />
                                        <button type="button" onClick={() => {
                                            const newArr = form._parsedCustomAllowances.filter((_, i) => i !== index);
                                            setForm({ ...form, _parsedCustomAllowances: newArr });
                                        }} className="w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors"></button>
                                    </div>
                                ))}
                                <button type="button" onClick={() => setForm({ ...form, _parsedCustomAllowances: [...form._parsedCustomAllowances, { key: '', value: 0 }] })} className="w-full text-sm py-2 rounded-lg border border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/10 transition-colors">+ Add Allowance</button>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <h4 className="text-md font-medium text-orange-400">Custom Deductions</h4>
                            <div className="space-y-3 dark-scrollbar max-h-48 overflow-y-auto pr-2">
                                {form._parsedCustomDeductions.map((item, index) => (
                                    <div key={index} className="flex gap-2 items-center">
                                        <input type="text" placeholder="Name (e.g. Loan Repayment)" value={item.key} onChange={e => {
                                            const newArr = [...form._parsedCustomDeductions];
                                            newArr[index].key = e.target.value;
                                            setForm({ ...form, _parsedCustomDeductions: newArr });
                                        }} className="input-base flex-1" />
                                        <input type="number" placeholder="Amount" value={item.value} onChange={e => {
                                            const newArr = [...form._parsedCustomDeductions];
                                            newArr[index].value = e.target.value;
                                            setForm({ ...form, _parsedCustomDeductions: newArr });
                                        }} className="input-base w-24 sm:w-32" />
                                        <button type="button" onClick={() => {
                                            const newArr = form._parsedCustomDeductions.filter((_, i) => i !== index);
                                            setForm({ ...form, _parsedCustomDeductions: newArr });
                                        }} className="w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors"></button>
                                    </div>
                                ))}
                                <button type="button" onClick={() => setForm({ ...form, _parsedCustomDeductions: [...form._parsedCustomDeductions, { key: '', value: 0 }] })} className="w-full text-sm py-2 rounded-lg border border-orange-500/30 text-orange-400 hover:bg-orange-500/10 transition-colors">+ Add Deduction</button>
                            </div>
                        </div>
                    </div>

                    {/* Document Uploads only applicable for New Employees because existing employees have a dedicated tab for document management. */}
                    {!isEditing && (
                        <div className="md:col-span-2 lg:col-span-3 pt-6 border-t border-[var(--border-main)] mt-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-[var(--brand-primary)]">Initial ID Documents & Passes</h3>
                                <button
                                    type="button"
                                    onClick={() => setDocuments([...documents, { document_type: 'NRIC', document_number: '', issue_date: '', expiry_date: '', file: null }])}
                                    className="text-sm px-4 py-1.5 rounded-lg bg-[var(--brand-primary)]/10 text-[var(--brand-primary)] hover:bg-[var(--brand-primary)]/20 border border-[var(--brand-primary)]/30 transition-colors"
                                >
                                    + Attach Document
                                </button>
                            </div>

                            <div className="space-y-3">
                                {documents.map((doc, index) => (
                                    <div key={index} className="flex flex-wrap items-center gap-3 p-4 rounded-xl bg-slate-800/30 border border-[var(--border-main)] relative group">
                                        <button
                                            type="button"
                                            onClick={() => setDocuments(documents.filter((_, i) => i !== index))}
                                            className="absolute -top-3 -right-3 w-7 h-7 rounded-full bg-slate-800 border border-red-500/50 text-red-400 flex items-center justify-center text-sm shadow-lg hover:bg-red-500/20 transition-colors opacity-0 xl:opacity-100 group-hover:opacity-100"
                                        >
                                            
                                        </button>

                                        <select
                                            value={doc.document_type}
                                            onChange={e => {
                                                const newDocs = [...documents];
                                                newDocs[index].document_type = e.target.value;
                                                setDocuments(newDocs);
                                            }}
                                            className="select-base w-32"
                                        >
                                            <option>NRIC</option>
                                            <option>FIN</option>
                                            <option>Passport</option>
                                            <option>Work Pass</option>
                                            <option>Skill Pass</option>
                                        </select>

                                        <input
                                            type="text"
                                            placeholder="Doc Number"
                                            required
                                            value={doc.document_number}
                                            onChange={e => {
                                                const newDocs = [...documents];
                                                newDocs[index].document_number = e.target.value;
                                                setDocuments(newDocs);
                                            }}
                                            className="input-base flex-1 min-w-[150px]"
                                        />

                                        <DatePicker
                                            selected={doc.issue_date}
                                            onChange={val => {
                                                const newDocs = [...documents];
                                                newDocs[index].issue_date = val;
                                                setDocuments(newDocs);
                                            }}
                                            placeholderText="Issue Date"
                                        />

                                        <DatePicker
                                            selected={doc.expiry_date}
                                            onChange={val => {
                                                const newDocs = [...documents];
                                                newDocs[index].expiry_date = val;
                                                setDocuments(newDocs);
                                            }}
                                            placeholderText="Expiry Date"
                                        />

                                        <div className="w-full xl:w-auto mt-2 xl:mt-0">
                                            <input
                                                type="file"
                                                onChange={e => {
                                                    const newDocs = [...documents];
                                                    newDocs[index].file = e.target.files[0];
                                                    setDocuments(newDocs);
                                                }}
                                                className="w-full text-sm text-[var(--text-muted)] file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border file:border-[var(--brand-primary)]/30 file:text-sm file:font-medium file:bg-[var(--brand-primary)]/10 file:text-[var(--brand-primary)] hover:file:bg-cyan-500/20 file:cursor-pointer"
                                            />
                                        </div>
                                    </div>
                                ))}
                                {documents.length === 0 && (
                                    <div className="text-center py-6 border border-dashed border-[var(--border-main)] rounded-xl bg-white/[0.02]">
                                        <p className="text-[var(--text-muted)] text-sm">No initial documents attached.</p>
                                        <p className="text-[var(--text-muted)] text-xs mt-1">You can attach NRICs, passports, or valid passes here, or upload them later on the employee's Documents tab.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="md:col-span-2 lg:col-span-3 pt-6 mt-4 border-t border-[var(--border-main)] flex items-center justify-end gap-4">
                        <button type="button" onClick={() => navigate('/employees')} className="px-6 py-3 rounded-xl border border-[var(--border-main)] text-[var(--text-muted)] hover:bg-[var(--bg-input)] transition-all font-medium">
                            Cancel
                        </button>
                        <button type="submit" disabled={submitting} className="btn-primary px-8 py-3 text-base flex items-center gap-2">
                            {submitting ? (
                                <>
                                    <div className="w-4 h-4 border-2 border-[var(--border-main)] border-t-white rounded-full animate-spin"></div>
                                    Saving...
                                </>
                            ) : (
                                isEditing ? 'Save Changes' : 'Create Employee Profile'
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    )
}
```
